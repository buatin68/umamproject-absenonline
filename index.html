<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Absensi Online</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-3xl mx-auto py-6 px-4">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">Absensi Online</h1>
      <span id="userDisplay" class="text-gray-600"></span>
    </div>
    <div class="mb-4 flex space-x-2">
      <button id="tab-absensi" class="tab-btn px-4 py-2 bg-teal-500 text-white rounded-lg" onclick="showTab('absensi')">Absensi</button>
      <button id="tab-laporan" class="tab-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg" onclick="showTab('laporan')">Laporan</button>
      <button id="tab-rekap" class="tab-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg" onclick="showTab('rekap')">Rekap</button>
      <button id="tab-grafik" class="tab-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg" onclick="showTab('grafik')">Grafik</button>
      <button id="tab-admin" style="display:none" class="tab-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg" onclick="showTab('admin')">Admin</button>
    </div>

    <!-- Absensi -->
    <div id="absensi-section" class="tab-section">
      <form id="absensiForm" class="bg-white rounded-xl p-6 shadow mb-4">
        <div class="mb-4">
          <label class="block font-semibold mb-2">Nama</label>
          <input id="nama" type="text" class="w-full px-4 py-3 rounded-xl bg-gray-100 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-teal-500" readonly>
        </div>
        <div class="mb-4">
          <label class="block font-semibold mb-2">Kelas</label>
          <select id="kelasSelector" class="w-full px-4 py-3 rounded-xl bg-gray-100 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-teal-500" disabled></select>
        </div>
        <button type="submit" class="w-full bg-teal-500 text-white font-semibold py-3 rounded-xl hover:bg-teal-600">Absen Sekarang</button>
      </form>
      <div id="absenMsg" class="mb-2 text-center text-green-600 font-semibold"></div>
    </div>

    <!-- Laporan -->
    <div id="laporan-section" class="tab-section hidden">
      <div id="laporanKelasFilterDiv" class="mb-3">
        <label class="block font-semibold mb-2">Filter Kelas</label>
        <select id="filterKelas" onchange="filterReport()" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 focus:outline-none focus:ring-2 focus:ring-teal-500"></select>
      </div>
      <table class="w-full bg-white rounded-xl shadow overflow-hidden">
        <thead>
          <tr class="bg-teal-100">
            <th class="py-2 px-4">Tanggal</th>
            <th class="py-2 px-4">Nama</th>
            <th class="py-2 px-4">Kelas</th>
            <th class="py-2 px-4">Waktu Absen</th>
          </tr>
        </thead>
        <tbody id="laporanTbody"></tbody>
      </table>
    </div>

    <!-- Rekap Bulanan -->
    <div id="rekap-section" class="tab-section hidden">
      <div class="mb-3 flex flex-col md:flex-row gap-2">
        <input type="month" id="filterBulan" class="rounded-xl border border-gray-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-teal-500" onchange="generateMonthlyReport()">
        <div id="rekapKelasFilterDiv" class="grow">
          <label class="block font-semibold mb-2">Filter Kelas</label>
          <select id="monthlyFilterKelas" onchange="generateMonthlyReport()" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 focus:outline-none focus:ring-2 focus:ring-teal-500"></select>
        </div>
      </div>
      <table class="w-full bg-white rounded-xl shadow overflow-hidden mt-2">
        <thead>
          <tr class="bg-teal-100">
            <th class="py-2 px-4">Nama</th>
            <th class="py-2 px-4">Kelas</th>
            <th class="py-2 px-4">Jumlah Hadir</th>
          </tr>
        </thead>
        <tbody id="rekapTbody"></tbody>
      </table>
    </div>

    <!-- Grafik -->
    <div id="grafik-section" class="tab-section hidden">
      <div id="grafikKelasFilterDiv" class="mb-3">
        <label class="block font-semibold mb-2">Pilih Kelas</label>
        <select id="chartKelasSelector" onchange="generateCharts()" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 focus:outline-none focus:ring-2 focus:ring-teal-500"></select>
      </div>
      <canvas id="absenChart" height="80"></canvas>
    </div>

    <!-- Admin -->
    <div id="admin-section" class="tab-section hidden">
      <h2 class="font-bold text-lg mb-2">Admin Panel</h2>
      <div id="adminContent" class="bg-white p-4 rounded-xl shadow"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzeHoT2aPnxPvQ2m9mpu_-r_uzvTRyu6qAwJtQ-xQJqg3b-Gyl06VIR6iKvP85PsMCS/exec";
    // Dummy user session and data for demo
    let currentUser = {username:"", role:""};
    const users = [
      {username:"admin", password:"admin", role:"admin", kelas:""},
      {username:"guru1", password:"guru1", role:"guru", kelas:"X IPA 1"},
      {username:"siswa1", password:"siswa1", role:"siswa", kelas:"X IPA 1"},
      {username:"siswa2", password:"siswa2", role:"siswa", kelas:"X IPA 2"}
    ];
    const kelasList = ["X IPA 1", "X IPA 2", "XI IPA 1", "XI IPA 2", "XII IPA 1"];
    let absensi = [];

    // Tab switch
    function showTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('bg-teal-500', 'text-white'));
      document.getElementById('tab-'+tab).classList.add('bg-teal-500','text-white');
      document.querySelectorAll('.tab-section').forEach(s => s.classList.add('hidden'));
      document.getElementById(tab+'-section').classList.remove('hidden');
      if(tab==='laporan') filterReport();
      if(tab==='rekap') generateMonthlyReport();
      if(tab==='grafik') generateCharts();
      if(tab==='admin') showAdmin();
    }

    // Login simulation
    function promptLogin() {
      let uname = prompt("Username:");
      let pwd = prompt("Password:");
      let found = users.find(u=>u.username===uname && u.password===pwd);
      if(found) {
        currentUser = {...found};
        initializeApp();
      } else {
        alert("Login gagal!");
        promptLogin();
      }
    }

    function updateCurrentUserDisplay() {
      document.getElementById('userDisplay').innerText = currentUser.username + (currentUser.role ? " ("+currentUser.role+")" : "");
      document.getElementById('nama').value = currentUser.username;
    }

    function initializeApp() {
      updateCurrentUserDisplay();
      // Kelas selector di halaman absensi
      const kelasSelector = document.getElementById('kelasSelector');
      kelasSelector.innerHTML = "";
      if (currentUser.role === 'admin') {
        kelasSelector.disabled = false;
        kelasList.forEach(k => {
          let opt = document.createElement('option');
          opt.value = k; opt.text = k;
          kelasSelector.appendChild(opt);
        });
      } else {
        kelasSelector.disabled = true;
        let opt = document.createElement('option');
        opt.value = currentUser.kelas; opt.text = currentUser.kelas;
        kelasSelector.appendChild(opt);
      }

      // Dropdown filter kelas di laporan, rekap, grafik
      let dropdowns = [
        {id:'filterKelas', wrapper:'laporanKelasFilterDiv'},
        {id:'monthlyFilterKelas', wrapper:'rekapKelasFilterDiv'},
        {id:'chartKelasSelector', wrapper:'grafikKelasFilterDiv'}
      ];
      dropdowns.forEach(d => {
        let sel = document.getElementById(d.id);
        sel.innerHTML = "";
        if (currentUser.role === 'admin') {
          kelasList.forEach(k => {
            let opt = document.createElement('option');
            opt.value = k; opt.text = k;
            sel.appendChild(opt);
          });
          document.getElementById(d.wrapper).style.display = '';
          sel.disabled = false;
        } else {
          let opt = document.createElement('option');
          opt.value = currentUser.kelas; opt.text = currentUser.kelas;
          sel.appendChild(opt);
          document.getElementById(d.wrapper).style.display = 'none';
          sel.disabled = true;
        }
      });

      // Tampilkan tab admin hanya jika admin
      document.getElementById('tab-admin').style.display = (currentUser.role === 'admin') ? 'flex' : 'none';

      // Ambil data absensi dari Spreadsheet
      fetchAbsensiFromSheet().then(() => {
        // Default ke tab absensi
        showTab('absensi');
      });
    }

    // Ambil data absensi dari Spreadsheet
    async function fetchAbsensiFromSheet() {
      try {
        const resp = await fetch(WEB_APP_URL);
        const data = await resp.json();
        // data adalah array [[nama,kelas,tanggal,waktu], ...]
        absensi = [];
        for(let i=0; i<data.length; i++) {
          // Lewatkan header jika ada
          if(i===0 && (data[i][0]||'').toLowerCase()==='nama') continue;
          absensi.push({
            nama: data[i][0], kelas: data[i][1], tanggal: data[i][2], waktu: data[i][3]
          });
        }
      } catch(e) {
        alert("Gagal mengambil data absensi dari spreadsheet: " + e);
        absensi = [];
      }
    }

    // Absen
    document.getElementById('absensiForm').onsubmit = function(e){
      e.preventDefault();
      let nama = document.getElementById('nama').value;
      let kelas = document.getElementById('kelasSelector').value;
      let tanggal = new Date().toISOString().slice(0,10);
      let waktu = new Date().toLocaleTimeString();
      let data = {nama, kelas, tanggal, waktu};

      fetch(WEB_APP_URL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: {'Content-Type': 'application/json'}
      })
      .then(resp => resp.text())
      .then(txt => {
        document.getElementById('absenMsg').innerText = "Absen berhasil!";
        // Refresh data setelah absen sukses
        setTimeout(()=>{
          document.getElementById('absenMsg').innerText="";
          fetchAbsensiFromSheet().then(() => {
            // Bisa refresh laporan dll jika sudah ada
            showTab('laporan');
          });
        }, 1000);
      })
      .catch(err => {
        document.getElementById('absenMsg').innerText = "Gagal absen: "+err;
      });
    }

    // Laporan harian
    function filterReport() {
      let kelasVal = document.getElementById('filterKelas').value;
      let tbody = document.getElementById('laporanTbody');
      tbody.innerHTML = "";
      absensi
        .filter(a=>a.kelas===kelasVal)
        .forEach(a=>{
          let tr = document.createElement('tr');
          tr.innerHTML = `<td class="py-2 px-4">${a.tanggal}</td>
            <td class="py-2 px-4">${a.nama}</td>
            <td class="py-2 px-4">${a.kelas}</td>
            <td class="py-2 px-4">${a.waktu}</td>`;
          tbody.appendChild(tr);
        });
    }

    // Rekap bulanan (ambil dari variabel lokal absensi)
    function generateMonthlyReport() {
      let kelasVal = document.getElementById('monthlyFilterKelas').value;
      let bulan = document.getElementById('filterBulan').value;
      let tbody = document.getElementById('rekapTbody');
      tbody.innerHTML = "";
      let data = {};
      absensi.filter(a=>{
        return a.kelas===kelasVal && (!bulan || a.tanggal.slice(0,7)===bulan);
      }).forEach(a=>{
        data[a.nama] = (data[a.nama]||0)+1;
      });
      Object.keys(data).forEach(nama=>{
        let tr = document.createElement('tr');
        tr.innerHTML = `<td class="py-2 px-4">${nama}</td>
          <td class="py-2 px-4">${kelasVal}</td>
          <td class="py-2 px-4">${data[nama]}</td>`;
        tbody.appendChild(tr);
      });
    }

    // Grafik
    let absenChart;
    function generateCharts() {
      let kelasVal = document.getElementById('chartKelasSelector').value;
      let dataPerHari = {};
      absensi.filter(a=>a.kelas===kelasVal).forEach(a=>{
        dataPerHari[a.tanggal] = (dataPerHari[a.tanggal]||0)+1;
      });
      let labels = Object.keys(dataPerHari).sort();
      let data = labels.map(l=>dataPerHari[l]);
      let ctx = document.getElementById('absenChart').getContext('2d');
      if(absenChart) absenChart.destroy();
      absenChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels, datasets: [{
            label: 'Jumlah Hadir',
            data,
            backgroundColor: 'rgba(16,185,129,0.6)'
          }]
        }
      });
    }

    // Admin panel
    function showAdmin() {
      let html = "<b>Data Absensi:</b><br><pre>"+JSON.stringify(absensi,null,2)+"</pre>";
      document.getElementById('adminContent').innerHTML = html;
    }

    // Autologin demo
    window.onload = function() {
      // Untuk demo: login sebagai admin/guru1/siswa1/siswa2
      promptLogin();
    }
  </script>
</body>
</html>
