<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Online - SDIT NURUL HIKMAH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
        /* Color Theory: Triadic Color Scheme - Teal, Coral, Gold */
        .gradient-bg { background: linear-gradient(135deg, #0046FF 0%, #0056FF 50%, #0066FF 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .btn-hover:hover { transform: translateY(-2px); transition: all 0.3s ease; }
        .glossy-btn {
            background: linear-gradient(145deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1), 0 4px 16px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .glossy-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        .glossy-btn:hover:before {
            left: 100%;
        }
        .glossy-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15), 0 8px 24px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.4);
        }
        /* Primary Color: Teal */
        .glossy-primary {
            background: linear-gradient(145deg, #0d9488, #14b8a6);
            color: white;
        }
        .glossy-primary:hover {
            background: linear-gradient(145deg, #0f766e, #0d9488);
        }
        /* Secondary Color: Coral */
        .glossy-coral {
            background: linear-gradient(145deg, #f97316, #ea580c);
            color: white;
        }
        .glossy-coral:hover {
            background: linear-gradient(145deg, #ea580c, #c2410c);
        }
        /* Tertiary Color: Gold */
        .glossy-gold {
            background: linear-gradient(145deg, #eab308, #ca8a04);
            color: white;
        }
        .glossy-gold:hover {
            background: linear-gradient(145deg, #ca8a04, #a16207);
        }
        /* Status Colors */
        .glossy-success {
            background: linear-gradient(145deg, #059669, #047857);
            color: white;
        }
        .glossy-success:hover {
            background: linear-gradient(145deg, #047857, #065f46);
        }
        .glossy-warning {
            background: linear-gradient(145deg, #d97706, #b45309);
            color: white;
        }
        .glossy-warning:hover {
            background: linear-gradient(145deg, #b45309, #92400e);
        }
        .glossy-info {
            background: linear-gradient(145deg, #0284c7, #0369a1);
            color: white;
        }
        .glossy-info:hover {
            background: linear-gradient(145deg, #0369a1, #075985);
        }
        .glossy-danger {
            background: linear-gradient(145deg, #dc2626, #b91c1c);
            color: white;
        }
        .glossy-danger:hover {
            background: linear-gradient(145deg, #b91c1c, #991b1b);
        }
        .glossy-neutral {
            background: linear-gradient(145deg, #6b7280, #4b5563);
            color: white;
        }
        .glossy-neutral:hover {
            background: linear-gradient(145deg, #4b5563, #374151);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-success {
            animation: pulseSuccess 2s ease-in-out;
        }
        @keyframes pulseSuccess {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            @page { 
                size: legal; 
                margin: 8mm; 
            }
            .page-break { 
                page-break-before: always; 
            }
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 8px;
                border-bottom: 1px solid #000;
                padding-bottom: 4px;
            }
            .print-title {
                font-size: 16px;
                font-weight: bold;
                margin-bottom: 4px;
            }
            .print-date {
                font-size: 12px;
                color: #666;
            }
            .print-signature {
                display: block !important;
                margin-top: 30px;
                page-break-inside: avoid;
            }
            .signature-section {
                display: flex;
                justify-content: space-between;
                margin-top: 40px;
            }
            .signature-box {
                text-align: center;
                width: 200px;
            }
            .signature-line {
                border-bottom: 1px solid #000;
                margin-top: 60px;
                margin-bottom: 5px;
            }
            .print-footer {
                display: block !important;
                position: fixed;
                bottom: 10mm;
                left: 0;
                right: 0;
                text-align: center;
                font-size: 10px;
                color: #666;
                border-top: 1px solid #ddd;
                padding-top: 5px;
            }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center px-4">
        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 w-full max-w-md card-shadow">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-4xl">üè´</span>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">SDIT NURUL HIKMAH</h1>
                <p class="text-white/80">Sistem Absensi Online</p>
            </div>
            
            <form onsubmit="handleLogin(event)" class="space-y-6">
                <div>
                    <label class="block text-white/90 font-semibold mb-2">Username</label>
                    <input type="text" id="username" required 
                           class="w-full px-4 py-3 rounded-xl bg-white/20 border border-white/30 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/50"
                           placeholder="Masukkan username">
                </div>
                
                <div>
                    <label class="block text-white/90 font-semibold mb-2">Password</label>
                    <input type="password" id="password" required 
                           class="w-full px-4 py-3 rounded-xl bg-white/20 border border-white/30 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/50"
                           placeholder="Masukkan password">
                </div>
                
                <button type="submit" class="glossy-btn glossy-primary w-full py-3 rounded-xl font-semibold text-lg">
                    üîê Masuk
                </button>
            </form>
            
            <div class="mt-6 p-4 bg-white/5 rounded-xl">
                <h3 class="text-white font-semibold mb-2">Informasi Login:</h3>
                <div class="text-white/70 text-sm space-y-1">
                    <p><strong>Admin:</strong> admin / admin</p>
                    <p><strong>Guru Kelas:</strong> nama kelas / 1234567</p>
                    <p class="text-xs mt-2 text-white/50">Contoh: 1A / 1234567</p>
                </div>
            </div>
            
            <div id="loginError" class="hidden mt-4 p-3 bg-red-500/20 border border-red-500/30 rounded-xl">
                <p class="text-red-300 text-sm text-center">Username atau password salah!</p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
    <!-- Header -->
    <header class="bg-white/10 backdrop-blur-md border-b border-white/20 no-print">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                        <span class="text-2xl">üè´</span>
                    </div>
                    <div>
                        <h1 class="text-white text-xl font-bold">SDIT NURUL HIKMAH</h1>
                        <p class="text-white/80 text-sm">Sistem Absensi Online</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-white text-right">
                        <p class="font-semibold" id="currentDate"></p>
                        <p class="text-sm opacity-80" id="currentTime"></p>
                        <p class="text-xs opacity-60" id="currentUser"></p>
                        <div class="flex items-center justify-end mt-1">
                            <div id="connectionStatus" class="text-xs px-2 py-1 rounded-full bg-yellow-500/20 text-yellow-300">
                                üîÑ Checking connection...
                            </div>
                        </div>
                    </div>
                    <button onclick="logout()" class="glossy-btn glossy-danger px-4 py-2 rounded-lg font-semibold text-sm">
                        üö™ Keluar
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Navigation Tabs -->
        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-2 mb-8 no-print">
            <div class="flex space-x-2">
                <button onclick="showTab('absensi')" id="tab-absensi" class="glossy-btn px-6 py-3 rounded-xl font-semibold flex-1 transition-all duration-300" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);">
                    üìù Absensi Siswa
                </button>
                <button onclick="showTab('laporan')" id="tab-laporan" class="glossy-btn px-6 py-3 rounded-xl font-semibold flex-1 text-white/70 transition-all duration-300 hover:text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);">
                    üìä Laporan Harian
                </button>
                <button onclick="showTab('rekap')" id="tab-rekap" class="glossy-btn px-6 py-3 rounded-xl font-semibold flex-1 text-white/70 transition-all duration-300 hover:text-white" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);">
                    üìã Rekap Bulanan
                </button>
                <button onclick="showTab('grafik')" id="tab-grafik" class="glossy-btn px-6 py-3 rounded-xl font-semibold flex-1 text-white/70 transition-all duration-300 hover:text-white" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);">
                    üìà Grafik
                </button>
                <button onclick="showTab('admin')" id="tab-admin" class="glossy-btn px-6 py-3 rounded-xl font-semibold flex-1 text-white/70 transition-all duration-300 hover:text-white" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); box-shadow: 0 4px 15px rgba(250, 112, 154, 0.3);">
                    ‚öôÔ∏è Admin
                </button>
            </div>
        </div>

        <!-- Absensi Tab -->
        <div id="content-absensi" class="tab-content fade-in">
            <!-- Form Absensi -->
            <div class="rounded-2xl p-8 card-shadow mb-8" style="background-color: #F8F8F8;">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <span class="mr-3">üë®‚Äçüéì</span>
                        Absensi Siswa
                    </h2>
                    <!-- Live Statistics -->
                    <div class="grid grid-cols-4 gap-2">
                        <div class="bg-green-600/90 rounded-lg p-2 text-center min-w-[40px] shadow-lg border border-green-500/30">
                            <div class="text-lg font-bold text-white" id="hadirCount">0</div>
                            <div class="text-green-100 text-xs font-semibold">Hadir</div>
                        </div>
                        <div class="bg-yellow-600/90 rounded-lg p-2 text-center min-w-[40px] shadow-lg border border-yellow-500/30">
                            <div class="text-lg font-bold text-white" id="sakitCount">0</div>
                            <div class="text-yellow-100 text-xs font-semibold">Sakit</div>
                        </div>
                        <div class="bg-blue-600/90 rounded-lg p-2 text-center min-w-[40px] shadow-lg border border-blue-500/30">
                            <div class="text-lg font-bold text-white" id="izinCount">0</div>
                            <div class="text-blue-100 text-xs font-semibold">Izin</div>
                        </div>
                        <div class="bg-red-600/90 rounded-lg p-2 text-center min-w-[40px] shadow-lg border border-red-500/30">
                            <div class="text-lg font-bold text-white" id="alphaCount">0</div>
                            <div class="text-red-100 text-xs font-semibold">Alpha</div>
                        </div>
                    </div>
                </div>
                
                <div class="grid md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Pilih Kelas</label>
                        <select id="kelasSelector" onchange="changeClass()" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-400/50" style="color: #374151;">
                            <option value="" style="background: #374151; color: #9CA3AF;">-- Pilih Kelas --</option>
                            <option value="1A" style="background: #0d9488; color: white;">Kelas 1A</option>
                            <option value="1B" style="background: #f97316; color: white;">Kelas 1B</option>
                            <option value="1C" style="background: #eab308; color: white;">Kelas 1C</option>
                            <option value="2A" style="background: #0d9488; color: white;">Kelas 2A</option>
                            <option value="2B" style="background: #f97316; color: white;">Kelas 2B</option>
                            <option value="3A" style="background: #eab308; color: white;">Kelas 3A</option>
                            <option value="3B" style="background: #0d9488; color: white;">Kelas 3B</option>
                            <option value="4A" style="background: #f97316; color: white;">Kelas 4A</option>
                            <option value="4B" style="background: #eab308; color: white;">Kelas 4B</option>
                            <option value="5A" style="background: #0d9488; color: white;">Kelas 5A</option>
                            <option value="5B" style="background: #f97316; color: white;">Kelas 5B</option>
                            <option value="6A" style="background: #eab308; color: white;">Kelas 6A</option>
                            <option value="6B" style="background: #0d9488; color: white;">Kelas 6B</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Tanggal Absensi</label>
                        <input type="date" id="attendanceDate" onchange="changeClass()" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-400/50">
                    </div>
                    
                    <div id="bulkAttendanceSection" style="display: none;">
                        <div class="flex gap-2">
                            <button onclick="markAllPresent()" class="glossy-btn flex-1 px-4 py-3 rounded-xl font-semibold text-sm" style="background: linear-gradient(145deg, #10b981, #059669); color: white; box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);">
                                ‚úÖ Hadir Semua
                            </button>
                            <button onclick="saveAllAttendance()" class="glossy-btn flex-1 px-4 py-3 rounded-xl font-semibold text-sm" style="background: linear-gradient(145deg, #8b5cf6, #7c3aed); color: white; box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);">
                                üíæ Simpan Absensi
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-4" id="studentList">
                    <p class="text-gray-500 text-center py-8">Pilih kelas terlebih dahulu untuk menampilkan daftar siswa</p>
                </div>
            </div>

            <!-- Recent Attendance Activity -->
            <div class="rounded-2xl p-8 card-shadow hidden" style="background-color: #F8F8F8;">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <span class="mr-3">üìã</span>
                    Aktivitas Absensi Terbaru
                </h2>
                <div class="space-y-3" id="recentAttendance">
                    <p class="text-gray-500 text-center py-4">Belum ada data absensi hari ini</p>
                </div>
            </div>
        </div>

        <!-- Laporan Tab -->
        <div id="content-laporan" class="tab-content hidden">
            <div class="rounded-2xl p-8 card-shadow" style="background-color: #F8F8F8;">
                <div class="flex justify-between items-center mb-6 no-print">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <span class="mr-3">üìà</span>
                        Laporan Absensi Harian
                    </h2>
                    <button onclick="exportReportToPDF()" class="glossy-btn glossy-info px-6 py-3 rounded-xl font-semibold">
                        üìÑ Export PDF
                    </button>
                </div>

                <!-- Print Header (hidden on screen) -->
                <div class="print-header hidden">
                    <div class="print-title">LAPORAN ABSENSI SISWA</div>
                    <div class="print-title">SDIT NURUL HIKMAH</div>
                    <div class="print-date" id="printDate"></div>
                </div>
                
                <!-- Filter -->
                <div class="grid md:grid-cols-3 gap-4 mb-6 no-print">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Filter Kelas</label>
                        <select id="filterKelas" onchange="filterReport()" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-400/50" style="color: #374151;">
                            <option value="" style="background: #374151; color: #9CA3AF;">Semua Kelas</option>
                            <option value="1A" style="background: #3B82F6; color: white;">Kelas 1A</option>
                            <option value="1B" style="background: #10B981; color: white;">Kelas 1B</option>
                            <option value="1C" style="background: #3B82F6; color: white;">Kelas 1C</option>
                            <option value="2A" style="background: #10B981; color: white;">Kelas 2A</option>
                            <option value="2B" style="background: #3B82F6; color: white;">Kelas 2B</option>
                            <option value="3A" style="background: #10B981; color: white;">Kelas 3A</option>
                            <option value="3B" style="background: #3B82F6; color: white;">Kelas 3B</option>
                            <option value="4A" style="background: #10B981; color: white;">Kelas 4A</option>
                            <option value="4B" style="background: #3B82F6; color: white;">Kelas 4B</option>
                            <option value="5A" style="background: #10B981; color: white;">Kelas 5A</option>
                            <option value="5B" style="background: #3B82F6; color: white;">Kelas 5B</option>
                            <option value="6A" style="background: #10B981; color: white;">Kelas 6A</option>
                            <option value="6B" style="background: #3B82F6; color: white;">Kelas 6B</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Tanggal Mulai</label>
                        <input type="date" id="startDate" onchange="filterReport()" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-400/50">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Tanggal Akhir</label>
                        <input type="date" id="endDate" onchange="filterReport()" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-400/50">
                    </div>
                </div>
                
                <!-- Tabel Laporan -->
                <div class="overflow-x-auto">
                    <table class="w-full text-gray-800">
                        <thead>
                            <tr class="border-b border-gray-300">
                                <th class="text-left py-3 px-4 font-semibold">No</th>
                                <th class="text-left py-3 px-4 font-semibold">Tanggal</th>
                                <th class="text-left py-3 px-4 font-semibold">Nama Siswa</th>
                                <th class="text-left py-3 px-4 font-semibold">Kelas</th>
                                <th class="text-left py-3 px-4 font-semibold">Status</th>
                                <th class="text-left py-3 px-4 font-semibold">Waktu</th>
                                <th class="text-left py-3 px-4 font-semibold">Keterangan</th>
                            </tr>
                        </thead>
                        <tbody id="reportTable">
                            <tr>
                                <td colspan="7" class="text-center py-8 text-gray-500">Belum ada data absensi</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Signature Section (Print Only) -->
                <div class="print-signature hidden">
                    <div class="signature-section">
                        <div class="signature-box">
                            <div style="margin-bottom: 10px;">Mengetahui,</div>
                            <div style="font-weight: bold; margin-bottom: 5px;">Kepala SDIT Nurul Hikmah</div>
                            <div class="signature-line"></div>
                            <div style="font-weight: bold;">(...........................)</div>
                        </div>
                        <div class="signature-box">
                            <div style="margin-bottom: 10px;" id="dailyReportDate">Jakarta, ...</div>
                            <div style="font-weight: bold; margin-bottom: 5px;">Guru Kelas</div>
                            <div class="signature-line"></div>
                            <div style="font-weight: bold;">(...........................)</div>
                        </div>
                    </div>
                </div>

                <!-- Print Footer (Print Only) -->
                <div class="print-footer hidden">
                    <div style="background: linear-gradient(90deg, #0d9488, #14b8a6); color: white; padding: 8px; border-radius: 15px; display: inline-block; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        ‚ú® @2025_Umam Project ‚ú®
                    </div>
                </div>
            </div>
        </div>

        <!-- Rekap Bulanan Tab -->
        <div id="content-rekap" class="tab-content hidden">
            <div class="rounded-2xl p-8 card-shadow" style="background-color: #F8F8F8;">
                <div class="flex justify-between items-center mb-6 no-print">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <span class="mr-3">üìã</span>
                        Rekap Absensi Bulanan
                    </h2>
                    <div class="flex gap-3">
                        <button onclick="refreshMonthlyPeriod()" class="glossy-btn glossy-primary px-6 py-3 rounded-xl font-semibold">
                            üîÑ Refresh
                        </button>
                        <button onclick="exportMonthlyReportToPDF()" class="glossy-btn glossy-coral px-6 py-3 rounded-xl font-semibold">
                            üìÑ Export PDF
                        </button>
                    </div>
                </div>

                <!-- Print Header (hidden on screen) -->
                <div class="print-header hidden">
                    <div class="print-title">REKAP ABSENSI BULANAN</div>
                    <div class="print-title">SDIT NURUL HIKMAH</div>
                    <div class="print-date" id="printMonthlyDate"></div>
                </div>
                
                <!-- Filter -->
                <div class="grid md:grid-cols-2 gap-4 mb-6 no-print">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Filter Kelas</label>
                        <select id="monthlyFilterKelas" onchange="generateMonthlyReport()" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-400/50" style="color: #374151;">
                            <option value="" style="background: #374151; color: #9CA3AF;">Semua Kelas</option>
                            <option value="1A" style="background: #3B82F6; color: white;">Kelas 1A</option>
                            <option value="1B" style="background: #10B981; color: white;">Kelas 1B</option>
                            <option value="1C" style="background: #3B82F6; color: white;">Kelas 1C</option>
                            <option value="2A" style="background: #10B981; color: white;">Kelas 2A</option>
                            <option value="2B" style="background: #3B82F6; color: white;">Kelas 2B</option>
                            <option value="3A" style="background: #10B981; color: white;">Kelas 3A</option>
                            <option value="3B" style="background: #3B82F6; color: white;">Kelas 3B</option>
                            <option value="4A" style="background: #10B981; color: white;">Kelas 4A</option>
                            <option value="4B" style="background: #3B82F6; color: white;">Kelas 4B</option>
                            <option value="5A" style="background: #10B981; color: white;">Kelas 5A</option>
                            <option value="5B" style="background: #3B82F6; color: white;">Kelas 5B</option>
                            <option value="6A" style="background: #10B981; color: white;">Kelas 6A</option>
                            <option value="6B" style="background: #3B82F6; color: white;">Kelas 6B</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Bulan & Tahun</label>
                        <input type="month" id="monthlyPeriod" onchange="generateMonthlyReport()" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-400/50">
                    </div>
                </div>
                
                <!-- Summary Cards -->
                <div class="grid md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-500/20 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-blue-800" id="monthlyWorkDays">0</div>
                        <div class="text-blue-700 text-sm font-semibold">Hari Kerja</div>
                    </div>
                    <div class="bg-green-500/20 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-green-800" id="monthlyAvgAttendance">0%</div>
                        <div class="text-green-700 text-sm font-semibold">Rata-rata Kehadiran</div>
                    </div>
                    <div class="bg-yellow-500/20 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-yellow-800" id="monthlyTotalStudents">0</div>
                        <div class="text-yellow-700 text-sm font-semibold">Total Siswa</div>
                    </div>
                    <div class="bg-purple-500/20 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-purple-800" id="monthlyTotalRecords">0</div>
                        <div class="text-purple-700 text-sm font-semibold">Total Absensi</div>
                    </div>
                </div>
                
                <!-- Monthly Report Table -->
                <div class="overflow-x-auto">
                    <table class="w-full text-gray-800">
                        <thead>
                            <tr class="border-b border-gray-300">
                                <th class="text-left py-3 px-4 font-semibold">No</th>
                                <th class="text-left py-3 px-4 font-semibold">Nama Siswa</th>
                                <th class="text-left py-3 px-4 font-semibold">Kelas</th>
                                <th class="text-left py-3 px-4 font-semibold">Hadir</th>
                                <th class="text-left py-3 px-4 font-semibold">Sakit</th>
                                <th class="text-left py-3 px-4 font-semibold">Izin</th>
                                <th class="text-left py-3 px-4 font-semibold">Alpha</th>
                                <th class="text-left py-3 px-4 font-semibold">% Kehadiran</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyReportTable">
                            <tr>
                                <td colspan="8" class="text-center py-8 text-gray-500">Pilih periode untuk menampilkan rekap bulanan</td>
                            </tr>
                        </tbody>
                        <tfoot id="monthlyReportTotal" style="display: none;">
                            <tr class="border-t-2 border-gray-400 bg-gray-100">
                                <td class="py-3 px-4 font-bold text-gray-800" colspan="3">TOTAL</td>
                                <td class="py-3 px-4 font-bold text-green-700" id="totalHadirBulanan">0</td>
                                <td class="py-3 px-4 font-bold text-yellow-700" id="totalSakitBulanan">0</td>
                                <td class="py-3 px-4 font-bold text-blue-700" id="totalIzinBulanan">0</td>
                                <td class="py-3 px-4 font-bold text-red-700" id="totalAlphaBulanan">0</td>
                                <td class="py-3 px-4 font-bold text-gray-800" id="totalPersentaseBulanan">0%</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Signature Section (Print Only) -->
                <div class="print-signature hidden">
                    <div class="signature-section">
                        <div class="signature-box">
                            <div style="margin-bottom: 10px;">Mengetahui,</div>
                            <div style="font-weight: bold; margin-bottom: 5px;">Kepala SDIT Nurul Hikmah</div>
                            <div class="signature-line"></div>
                            <div style="font-weight: bold;">(...........................)</div>
                        </div>
                        <div class="signature-box">
                            <div style="margin-bottom: 10px;" id="monthlyReportSignatureDate">Jakarta, ...</div>
                            <div style="font-weight: bold; margin-bottom: 5px;">Guru Kelas</div>
                            <div class="signature-line"></div>
                            <div style="font-weight: bold;">(...........................)</div>
                        </div>
                    </div>
                </div>

                <!-- Print Footer (Print Only) -->
                <div class="print-footer hidden">
                    <div style="background: linear-gradient(90deg, #0d9488, #14b8a6); color: white; padding: 8px; border-radius: 15px; display: inline-block; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        ‚ú® @2025_Umam Project ‚ú®
                    </div>
                </div>
            </div>
        </div>

        <!-- Grafik Tab -->
        <div id="content-grafik" class="tab-content hidden">
            <div class="space-y-8">
                <!-- Chart Controls -->
                <div class="rounded-2xl p-6 card-shadow no-print" style="background-color: #F8F8F8;">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="mr-3">üìà</span>
                        Grafik Absensi
                    </h2>
                    
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Filter Kelas</label>
                            <select id="chartFilterKelas" onchange="updateCharts()" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-400/50" style="color: #374151;">
                                <option value="" style="background: #374151; color: #9CA3AF;">Semua Kelas</option>
                                <option value="1A" style="background: #3B82F6; color: white;">Kelas 1A</option>
                                <option value="1B" style="background: #10B981; color: white;">Kelas 1B</option>
                                <option value="1C" style="background: #3B82F6; color: white;">Kelas 1C</option>
                                <option value="2A" style="background: #10B981; color: white;">Kelas 2A</option>
                                <option value="2B" style="background: #3B82F6; color: white;">Kelas 2B</option>
                                <option value="3A" style="background: #10B981; color: white;">Kelas 3A</option>
                                <option value="3B" style="background: #3B82F6; color: white;">Kelas 3B</option>
                                <option value="4A" style="background: #10B981; color: white;">Kelas 4A</option>
                                <option value="4B" style="background: #3B82F6; color: white;">Kelas 4B</option>
                                <option value="5A" style="background: #10B981; color: white;">Kelas 5A</option>
                                <option value="5B" style="background: #3B82F6; color: white;">Kelas 5B</option>
                                <option value="6A" style="background: #10B981; color: white;">Kelas 6A</option>
                                <option value="6B" style="background: #3B82F6; color: white;">Kelas 6B</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Periode</label>
                            <select id="chartPeriod" onchange="updateCharts()" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-400/50" style="color: #374151;">
                                <option value="7" style="background: #374151; color: white;">7 Hari Terakhir</option>
                                <option value="30" style="background: #374151; color: white;">30 Hari Terakhir</option>
                                <option value="90" style="background: #374151; color: white;">3 Bulan Terakhir</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Jenis Grafik</label>
                            <select id="chartType" onchange="updateCharts()" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-400/50" style="color: #374151;">
                                <option value="pie" style="background: #374151; color: white;">Pie Chart</option>
                                <option value="bar" style="background: #374151; color: white;">Bar Chart</option>
                                <option value="line" style="background: #374151; color: white;">Line Chart</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons for Charts -->
                <div class="flex justify-end gap-3 mb-6 no-print">
                    <button onclick="refreshCharts()" class="glossy-btn glossy-primary px-6 py-3 rounded-xl font-semibold">
                        üîÑ Refresh Grafik
                    </button>
                    <button onclick="exportChartsToPDF()" class="glossy-btn glossy-gold px-6 py-3 rounded-xl font-semibold">
                        üìÑ Export PDF
                    </button>
                </div>

                <!-- Charts Container -->
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Status Distribution Chart -->
                    <div class="rounded-2xl p-6 card-shadow" style="background-color: #F8F8F8;">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Distribusi Status Absensi</h3>
                        <div class="relative h-64 flex items-center justify-center">
                            <canvas id="statusChart" width="300" height="200"></canvas>
                        </div>
                        <div id="statusLegend" class="mt-4 grid grid-cols-2 gap-2 text-sm"></div>
                    </div>

                    <!-- Trend Chart -->
                    <div class="rounded-2xl p-6 card-shadow" style="background-color: #F8F8F8;">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Tren Kehadiran</h3>
                        <div class="relative h-64 flex items-center justify-center">
                            <canvas id="trendChart" width="300" height="200"></canvas>
                        </div>
                        <div id="trendInfo" class="mt-4 text-sm text-gray-600"></div>
                    </div>
                </div>

                <!-- Class Comparison Chart (Admin Only) -->
                <div id="classComparisonChart" class="rounded-2xl p-6 card-shadow" style="background-color: #F8F8F8;">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Perbandingan Antar Kelas</h3>
                    <div class="relative h-80 flex items-center justify-center">
                        <canvas id="classChart" width="600" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Tab -->
        <div id="content-admin" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Statistik -->
                <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 card-shadow">
                    <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                        <span class="mr-3">üìä</span>
                        Statistik Keseluruhan
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-4 bg-white/5 rounded-xl">
                            <span class="text-white">Total Absensi</span>
                            <span class="text-2xl font-bold text-white" id="totalAbsensi">0</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-green-500/20 rounded-xl">
                            <span class="text-green-200">Total Hadir</span>
                            <span class="text-2xl font-bold text-green-300" id="totalHadir">0</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-yellow-500/20 rounded-xl">
                            <span class="text-yellow-200">Total Sakit</span>
                            <span class="text-2xl font-bold text-yellow-300" id="totalSakit">0</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-blue-500/20 rounded-xl">
                            <span class="text-blue-200">Total Izin</span>
                            <span class="text-2xl font-bold text-blue-300" id="totalIzin">0</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-red-500/20 rounded-xl">
                            <span class="text-red-200">Total Alpha</span>
                            <span class="text-2xl font-bold text-red-300" id="totalAlpha">0</span>
                        </div>
                    </div>
                </div>

                <!-- Pengaturan -->
                <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 card-shadow">
                    <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                        <span class="mr-3">‚öôÔ∏è</span>
                        Pengaturan
                    </h2>
                    
                    <div class="space-y-4">
                        <button onclick="testConnection()" class="glossy-btn glossy-success w-full py-3 rounded-xl font-semibold">
                            üîó Test Koneksi Google Sheets
                        </button>
                        <button onclick="exportData()" class="glossy-btn glossy-info w-full py-3 rounded-xl font-semibold">
                            üì§ Export Data
                        </button>
                        <button onclick="clearTodayData()" class="glossy-btn glossy-warning w-full py-3 rounded-xl font-semibold">
                            üóëÔ∏è Hapus Data Hari Ini
                        </button>
                        <button onclick="clearAllData()" class="glossy-btn glossy-danger w-full py-3 rounded-xl font-semibold">
                            ‚ö†Ô∏è Hapus Semua Data
                        </button>
                        <div class="bg-white/5 rounded-xl p-4 mt-6">
                            <h3 class="text-white font-semibold mb-2">Informasi Sistem</h3>
                            <p class="text-white/70 text-sm">Versi: 1.0.0</p>
                            <p class="text-white/70 text-sm">Terakhir diperbarui: <span id="lastUpdate">-</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-8 max-w-md mx-4 card-shadow pulse-success">
            <div class="text-center">
                <div class="text-6xl mb-4">‚úÖ</div>
                <h3 class="text-2xl font-bold text-white mb-2">Berhasil!</h3>
                <p class="text-white/80 mb-6" id="successMessage">Absensi berhasil disimpan</p>
                <button onclick="closeModal()" class="glossy-btn glossy-success px-8 py-3 rounded-xl font-semibold">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script>
        // Login credentials
        const loginCredentials = {
            'admin': 'admin',
            '1A': '1234567',
            '1B': '1234567',
            '1C': '1234567',
            '2A': '1234567',
            '2B': '1234567',
            '3A': '1234567',
            '3B': '1234567',
            '4A': '1234567',
            '4B': '1234567',
            '5A': '1234567',
            '5B': '1234567',
            '6A': '1234567',
            '6B': '1234567'
        };
        
        // Current user info
        let currentUser = {
            username: '',
            role: '', // 'admin' or 'teacher'
            allowedClass: '' // for teachers, which class they can access
        };
        
        // Data storage
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || [];
        
        // Student data by class
        const studentsByClass = {
            '1A': [
                { id: 1, name: 'AHMAD FAIZ RAMADHAN' },
                { id: 2, name: 'AISYAH PUTRI MAHARANI' },
                { id: 3, name: 'ALIF RIZKY PRATAMA' },
                { id: 4, name: 'ANISA RAHMA SARI' },
                { id: 5, name: 'BAYU SETIAWAN' },
                { id: 6, name: 'CITRA DEWI LESTARI' },
                { id: 7, name: 'DANI KURNIAWAN' },
                { id: 8, name: 'ELSA PERMATA SARI' },
                { id: 9, name: 'FAJAR NUGRAHA' },
                { id: 10, name: 'GITA MAHARANI' }
            ],
            '1B': [
                { id: 1, name: 'HADI WIJAYA' },
                { id: 2, name: 'IKA SARI DEWI' },
                { id: 3, name: 'JOKO SANTOSO' },
                { id: 4, name: 'KIRANA PUTRI' },
                { id: 5, name: 'LUKI HERMAWAN' },
                { id: 6, name: 'MAYA SARI' },
                { id: 7, name: 'NANDA PRATAMA' },
                { id: 8, name: 'OLIVIA RAMADHANI' },
                { id: 9, name: 'PUTRA WIJAYA' },
                { id: 10, name: 'QORI AMANDA' }
            ],
            '1C': [
                { id: 1, name: 'RAFI MAULANA' },
                { id: 2, name: 'SARI INDAH LESTARI' },
                { id: 3, name: 'TAUFIK HIDAYAT' },
                { id: 4, name: 'UMI KALSUM' },
                { id: 5, name: 'VINA MAHARANI' },
                { id: 6, name: 'WAHYU PRATAMA' },
                { id: 7, name: 'XENIA PUTRI' },
                { id: 8, name: 'YOGA SETIAWAN' },
                { id: 9, name: 'ZAHRA AMANDA' },
                { id: 10, name: 'ZIDAN MAULANA' }
            ],
            '2A': [
                { id: 1, name: 'ABDUL RAHMAN' },
                { id: 2, name: 'BELLA SAFITRI' },
                { id: 3, name: 'CANDRA KIRANA' },
                { id: 4, name: 'DINDA PERMATA' },
                { id: 5, name: 'ERICK PRATAMA' },
                { id: 6, name: 'FITRI RAMADHANI' },
                { id: 7, name: 'GALIH SETIAWAN' },
                { id: 8, name: 'HANA MAHARANI' },
                { id: 9, name: 'IRFAN MAULANA' },
                { id: 10, name: 'JASMINE PUTRI' }
            ],
            '2B': [
                { id: 1, name: 'KEVIN WIJAYA' },
                { id: 2, name: 'LUNA SARI DEWI' },
                { id: 3, name: 'MARIO SANTOSO' },
                { id: 4, name: 'NOVA RAMADHANI' },
                { id: 5, name: 'OSCAR PRATAMA' },
                { id: 6, name: 'PUTRI MAHARANI' },
                { id: 7, name: 'QIARA AMANDA' },
                { id: 8, name: 'RIZKI MAULANA' },
                { id: 9, name: 'SINTA DEWI' },
                { id: 10, name: 'TEGAR WIJAYA' }
            ],
            '3A': [
                { id: 1, name: 'ANDI SETIAWAN' },
                { id: 2, name: 'BUNGA CITRA' },
                { id: 3, name: 'CAHYA PRATAMA' },
                { id: 4, name: 'DEWI SARTIKA' },
                { id: 5, name: 'EDI KURNIAWAN' },
                { id: 6, name: 'FANI RAMADHANI' },
                { id: 7, name: 'GILANG RAMADHAN' },
                { id: 8, name: 'HESTI MAHARANI' },
                { id: 9, name: 'INDRA MAULANA' },
                { id: 10, name: 'JIHAN PUTRI' }
            ],
            '3B': [
                { id: 1, name: 'KRISNA WIJAYA' },
                { id: 2, name: 'LARAS SARI' },
                { id: 3, name: 'MIKO SANTOSO' },
                { id: 4, name: 'NISA RAMADHANI' },
                { id: 5, name: 'OKTA PRATAMA' },
                { id: 6, name: 'PRITA MAHARANI' },
                { id: 7, name: 'QONITA AMANDA' },
                { id: 8, name: 'REZA MAULANA' },
                { id: 9, name: 'SARI DEWI LESTARI' },
                { id: 10, name: 'TONI WIJAYA' }
            ],
            '4A': [
                { id: 1, name: 'ARIF SETIAWAN' },
                { id: 2, name: 'BUDI CITRA KIRANA' },
                { id: 3, name: 'CICI PRATAMA' },
                { id: 4, name: 'DONI SARTIKA' },
                { id: 5, name: 'EKA KURNIAWAN' },
                { id: 6, name: 'FIRA RAMADHANI' },
                { id: 7, name: 'GANI RAMADHAN' },
                { id: 8, name: 'HILDA MAHARANI' },
                { id: 9, name: 'IVAN MAULANA' },
                { id: 10, name: 'JULIA PUTRI' }
            ],
            '4B': [
                { id: 1, name: 'KIKI WIJAYA' },
                { id: 2, name: 'LINA SARI DEWI' },
                { id: 3, name: 'MIRA SANTOSO' },
                { id: 4, name: 'NIKO RAMADHANI' },
                { id: 5, name: 'OKI PRATAMA' },
                { id: 6, name: 'PINA MAHARANI' },
                { id: 7, name: 'QIRA AMANDA' },
                { id: 8, name: 'RIAN MAULANA' },
                { id: 9, name: 'SISKA DEWI' },
                { id: 10, name: 'TIKA WIJAYA' }
            ],
            '5A': [
                { id: 1, name: 'AGUS SETIAWAN' },
                { id: 2, name: 'BINA CITRA' },
                { id: 3, name: 'CANDRA PRATAMA' },
                { id: 4, name: 'DESI SARTIKA' },
                { id: 5, name: 'ERIK KURNIAWAN' },
                { id: 6, name: 'FINA RAMADHANI' },
                { id: 7, name: 'GINA RAMADHAN' },
                { id: 8, name: 'HANI MAHARANI' },
                { id: 9, name: 'IMAN MAULANA' },
                { id: 10, name: 'JENI PUTRI' }
            ],
            '5B': [
                { id: 1, name: 'KOKO WIJAYA' },
                { id: 2, name: 'LILI SARI' },
                { id: 3, name: 'MINA SANTOSO' },
                { id: 4, name: 'NANA RAMADHANI' },
                { id: 5, name: 'OVI PRATAMA' },
                { id: 6, name: 'PIKA MAHARANI' },
                { id: 7, name: 'QINA AMANDA' },
                { id: 8, name: 'RINI MAULANA' },
                { id: 9, name: 'SARI DEWI' },
                { id: 10, name: 'TINA WIJAYA' }
            ],
            '6A': [
                { id: 1, name: 'ADZKIYA SYBILLA QALBI' },
                { id: 2, name: 'AFIQAH KHAIRINA MICHEL' },
                { id: 3, name: 'ALISHA ZAEDAH MUHSINA' },
                { id: 4, name: 'ATHASYA NAILA SYARIF' },
                { id: 5, name: 'AULIA NURIA ZAHRA' },
                { id: 6, name: 'AZKA KYANO ALDRIKO' },
                { id: 7, name: 'DINDA CITRA ANGGRAINI' },
                { id: 8, name: 'EVAN OMAR NARENDRA' },
                { id: 9, name: 'GILANG LANGIT RAMADHAN' },
                { id: 10, name: 'HAUZAN BASIL ANWAR TSABIT' },
                { id: 11, name: 'HILYA ABDULLAH SULI' },
                { id: 12, name: 'LAUDYA FAEYZA ALLMIRA' },
                { id: 13, name: 'MAULANA ALMER ARKANANTA' },
                { id: 14, name: 'MUHAMMAD ADRIAN ZAFRAN' },
                { id: 15, name: 'MUHAMMAD ARDHAN HIDAYAT' },
                { id: 16, name: 'MUHAMMAD AZKAL FAEYZA' },
                { id: 17, name: 'MUHAMMAD FADLAN RAMADHAN' },
                { id: 18, name: 'MUHAMMAD REVAN ALVARONIZAM' },
                { id: 19, name: 'NABILA SYAFIA YUHANIZA' },
                { id: 20, name: 'NALINI SYIFA VIMALA' },
                { id: 21, name: 'NISRINA NURUL AINI' },
                { id: 22, name: 'OCEANO CHAVEZ KAMANDHAKA PUTRA' },
                { id: 23, name: 'RAYYANAZIA YASMIN NADHIFA' },
                { id: 24, name: 'RIZKILAH ATTAYA ATTHORIQ' },
                { id: 25, name: 'SYAFIQ ASSAD BASWEDAN' },
                { id: 26, name: 'WARDA FARIDAH' },
                { id: 27, name: 'YUMNA \'AINAL HADZIQAH' },
                { id: 28, name: 'ZAHIRA FAUZIYYAH PUTRI' },
                { id: 29, name: 'ZARA HASNA KAMILA' }
            ],
            '6B': [
                { id: 1, name: 'ADAM SETIAWAN' },
                { id: 2, name: 'BELLA CITRA' },
                { id: 3, name: 'CAKRA PRATAMA' },
                { id: 4, name: 'DARA SARTIKA' },
                { id: 5, name: 'ENZO KURNIAWAN' },
                { id: 6, name: 'FARA RAMADHANI' },
                { id: 7, name: 'GARA RAMADHAN' },
                { id: 8, name: 'HARA MAHARANI' },
                { id: 9, name: 'IVAN MAULANA' },
                { id: 10, name: 'JARA PUTRI' }
            ]
        };
        
        let currentClass = '';
        let currentStudents = [];
        
        // Handle login
        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('loginError');
            
            // Validate input
            if (!username || !password) {
                errorDiv.querySelector('p').textContent = 'Username dan password harus diisi!';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Check credentials
            if (loginCredentials[username] && loginCredentials[username] === password) {
                // Set current user
                currentUser.username = username;
                if (username === 'admin') {
                    currentUser.role = 'admin';
                    currentUser.allowedClass = '';
                } else {
                    currentUser.role = 'teacher';
                    currentUser.allowedClass = username;
                }
                
                // Hide login screen and show main app
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                // Initialize app
                initializeApp();
                
                // Hide error if it was showing
                errorDiv.classList.add('hidden');
                
                // Clear form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
            } else {
                // Show error message
                errorDiv.querySelector('p').textContent = 'Username atau password salah!';
                errorDiv.classList.remove('hidden');
                
                // Add shake animation to form
                const form = event.target;
                form.classList.add('shake');
                setTimeout(() => form.classList.remove('shake'), 500);
                
                // Clear password field
                document.getElementById('password').value = '';
                document.getElementById('password').focus();
            }
        }
        
        // Logout function
        function logout() {
            // Reset current user
            currentUser = { username: '', role: '', allowedClass: '' };
            
            // Show login screen and hide main app
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // Clear form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').classList.add('hidden');
        }
        
        // Initialize app after login
        function initializeApp() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            updateTodayStats();
            updateRecentAttendance();
            updateOverallStats();
            loadReportData();
            generateMonthlyReport(); // Auto-load monthly report
            updateCharts(); // Auto-load charts
            
            // Set default dates for report and attendance
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            document.getElementById('attendanceDate').value = today;
            
            // Set default month for monthly report
            const currentMonth = new Date().toISOString().slice(0, 7);
            document.getElementById('monthlyPeriod').value = currentMonth;
            
            // Update current user display
            document.getElementById('currentUser').textContent = `Login sebagai: ${currentUser.username}`;
            
            // Configure interface based on user role
            if (currentUser.role === 'teacher') {
                // Auto-select their class
                document.getElementById('kelasSelector').value = currentUser.allowedClass;
                changeClass();
                
                // Hide admin tab completely
                document.getElementById('tab-admin').style.display = 'none';
                
                // Disable class selector for teachers
                document.getElementById('kelasSelector').disabled = true;
                document.getElementById('kelasSelector').style.opacity = '0.7';
                
                // Set filter to their class in report and disable it
                document.getElementById('filterKelas').value = currentUser.allowedClass;
                document.getElementById('filterKelas').disabled = true;
                document.getElementById('filterKelas').style.opacity = '0.7';
                
                // Set filter for monthly report
                document.getElementById('monthlyFilterKelas').value = currentUser.allowedClass;
                document.getElementById('monthlyFilterKelas').disabled = true;
                document.getElementById('monthlyFilterKelas').style.opacity = '0.7';
                
                // Set filter for chart
                document.getElementById('chartFilterKelas').value = currentUser.allowedClass;
                document.getElementById('chartFilterKelas').disabled = true;
                document.getElementById('chartFilterKelas').style.opacity = '0.7';
                
                // Hide class comparison chart for teachers
                document.getElementById('classComparisonChart').style.display = 'none';
                
                // Filter report to show only their class
                filterReport();
                generateMonthlyReport();
                updateCharts();
                
                // Update navigation to only show relevant tabs
                document.querySelector('.flex.space-x-2').innerHTML = `
                    <button onclick="showTab('absensi')" id="tab-absensi" class="glossy-btn px-6 py-3 rounded-xl font-semibold flex-1 transition-all duration-300" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);">
                        üìù Absensi Siswa
                    </button>
                    <button onclick="showTab('laporan')" id="tab-laporan" class="glossy-btn px-6 py-3 rounded-xl font-semibold flex-1 text-white/70 transition-all duration-300 hover:text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);">
                        üìä Laporan Harian
                    </button>
                    <button onclick="showTab('rekap')" id="tab-rekap" class="glossy-btn px-6 py-3 rounded-xl font-semibold flex-1 text-white/70 transition-all duration-300 hover:text-white" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);">
                        üìã Rekap Bulanan
                    </button>
                    <button onclick="showTab('grafik')" id="tab-grafik" class="glossy-btn px-6 py-3 rounded-xl font-semibold flex-1 text-white/70 transition-all duration-300 hover:text-white" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); box-shadow: 0 4px 15px rgba(67, 233, 123, 0.3);">
                        üìà Grafik
                    </button>
                `;
            } else {
                // Admin sees all tabs
                document.getElementById('tab-admin').style.display = 'block';
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in (optional - for development)
            // For production, always start with login screen
        });
        
        // Change class function
        function changeClass() {
            const selectedClass = document.getElementById('kelasSelector').value;
            currentClass = selectedClass;
            
            if (selectedClass) {
                currentStudents = studentsByClass[selectedClass] || [];
                document.getElementById('bulkAttendanceSection').style.display = 'block';
                generateStudentList();
            } else {
                currentStudents = [];
                document.getElementById('bulkAttendanceSection').style.display = 'none';
                document.getElementById('studentList').innerHTML = '<p class="text-white/60 text-center py-8">Pilih kelas terlebih dahulu untuk menampilkan daftar siswa</p>';
            }
        }
        
        // Generate student list with attendance buttons
        function generateStudentList() {
            const container = document.getElementById('studentList');
            const selectedDate = document.getElementById('attendanceDate').value || new Date().toISOString().split('T')[0];
            
            if (!currentStudents.length) {
                container.innerHTML = '<p class="text-white/60 text-center py-8">Pilih kelas terlebih dahulu untuk menampilkan daftar siswa</p>';
                return;
            }
            
            // Sort students alphabetically by name
            const sortedStudents = [...currentStudents].sort((a, b) => a.name.localeCompare(b.name));
            
            container.innerHTML = sortedStudents.map((student, index) => {
                // Check if student already has attendance for selected date
                const existingAttendance = attendanceData.find(item => 
                    item.nama === student.name && item.tanggal === selectedDate && item.kelas === currentClass
                );
                
                const currentStatus = existingAttendance ? existingAttendance.status : '';
                
                return `
                    <div class="bg-white/5 rounded-xl p-4">
                        <div class="flex items-center mb-3">
                            <div class="text-gray-600 text-sm mr-5 min-w-[30px]">${index + 1}.</div>
                            <div class="text-gray-800 font-semibold flex-1">${student.name}</div>
                        </div>
                        <div class="grid grid-cols-4 gap-1">
                            <button onclick="setAttendance(${student.id}, '${student.name}', 'Hadir')" 
                                    class="glossy-btn ${currentStatus === 'Hadir' ? 'glossy-success' : ''} px-2 py-1 rounded-lg text-xs font-semibold">
                                ‚úÖ Hadir
                            </button>
                            <button onclick="setAttendance(${student.id}, '${student.name}', 'Sakit')" 
                                    class="glossy-btn ${currentStatus === 'Sakit' ? 'glossy-warning' : ''} px-2 py-1 rounded-lg text-xs font-semibold">
                                ü§í Sakit
                            </button>
                            <button onclick="setAttendance(${student.id}, '${student.name}', 'Izin')" 
                                    class="glossy-btn ${currentStatus === 'Izin' ? 'glossy-info' : ''} px-2 py-1 rounded-lg text-xs font-semibold">
                                üìù Izin
                            </button>
                            <button onclick="setAttendance(${student.id}, '${student.name}', 'Alpha')" 
                                    class="glossy-btn ${currentStatus === 'Alpha' ? 'glossy-danger' : ''} px-2 py-1 rounded-lg text-xs font-semibold">
                                ‚ùå Alpha
                            </button>
                        </div>
                        ${currentStatus ? `<div class="mt-2 text-center text-sm text-gray-700 font-medium">Status: ${currentStatus}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Mark all students as present
        async function markAllPresent() {
            if (!currentClass || !currentStudents.length) {
                alert('Pilih kelas terlebih dahulu!');
                return;
            }
            
            const selectedDate = document.getElementById('attendanceDate').value || new Date().toISOString().split('T')[0];
            const currentTime = new Date().toLocaleTimeString('id-ID');
            const currentTimestamp = new Date().toISOString();
            
            // Show loading state
            const markAllBtn = event.target;
            const originalText = markAllBtn.innerHTML;
            markAllBtn.innerHTML = '‚è≥ Menandai & Sync...';
            markAllBtn.disabled = true;
            
            try {
                // Remove existing attendance for selected date for this class
                attendanceData = attendanceData.filter(item => 
                    !(item.tanggal === selectedDate && item.kelas === currentClass)
                );
                
                // Create attendance records for all students
                const newRecords = [];
                currentStudents.forEach(student => {
                    const formData = {
                        id: Date.now() + student.id, // Unique ID
                        nama: student.name,
                        kelas: currentClass,
                        status: 'Hadir',
                        keterangan: '',
                        tanggal: selectedDate,
                        waktu: currentTime,
                        timestamp: currentTimestamp
                    };
                    attendanceData.push(formData);
                    newRecords.push(formData);
                });
                
                localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                
                // Send to Google Sheets
                await sendToGoogleSheets(newRecords);
                
                // Update displays
                generateStudentList();
                updateTodayStats();
                updateRecentAttendance();
                updateOverallStats();
                loadReportData();
                
                // Show success message
                const dateStr = new Date(selectedDate).toLocaleDateString('id-ID');
                alert(`‚úÖ Semua ${currentStudents.length} siswa kelas ${currentClass} telah ditandai hadir untuk tanggal ${dateStr} dan berhasil disync ke Google Sheets!`);
                
            } catch (error) {
                console.error('Error in markAllPresent:', error);
                alert(`‚ö†Ô∏è Data berhasil disimpan lokal tapi gagal sync ke Google Sheets: ${error.message}`);
                
                // Still update displays even if sync failed
                generateStudentList();
                updateTodayStats();
                updateRecentAttendance();
                updateOverallStats();
                loadReportData();
            } finally {
                // Restore button state
                markAllBtn.innerHTML = originalText;
                markAllBtn.disabled = false;
            }
        }
        
        // Set attendance for individual student
        async function setAttendance(studentId, studentName, status) {
            if (!currentClass) {
                alert('Pilih kelas terlebih dahulu!');
                return;
            }
            
            const selectedDate = document.getElementById('attendanceDate').value || new Date().toISOString().split('T')[0];
            
            // Remove existing attendance for selected date if any
            attendanceData = attendanceData.filter(item => 
                !(item.nama === studentName && item.tanggal === selectedDate && item.kelas === currentClass)
            );
            
            // Add new attendance
            const formData = {
                id: Date.now(),
                nama: studentName,
                kelas: currentClass,
                status: status,
                keterangan: '',
                tanggal: selectedDate,
                waktu: new Date().toLocaleTimeString('id-ID'),
                timestamp: new Date().toISOString()
            };
            
            attendanceData.push(formData);
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            
            // Auto-sync to Google Sheets (silent, no loading state for individual clicks)
            try {
                await sendToGoogleSheets([formData]);
                console.log(`‚úÖ Auto-sync: ${studentName} (${status}) berhasil dikirim ke Google Sheets`);
            } catch (error) {
                console.warn(`‚ö†Ô∏è Auto-sync gagal untuk ${studentName}:`, error.message);
                // Don't show error to user for individual attendance, just log it
            }
            
            // Update displays
            generateStudentList();
            updateTodayStats();
            updateRecentAttendance();
            updateOverallStats();
            loadReportData();
        }
        
        // Google Sheets Configuration
        const GOOGLE_SHEETS_CONFIG = {
            // URL Google Apps Script Web App
            WEB_APP_URL: 'https://script.google.com/macros/s/AKfycbzeHoT2aPnxPvQ2m9mpu_-r_uzvTRyu6qAwJtQ-xQJqg3b-Gyl06VIR6iKvP85PsMCS/exec',
            // Timeout untuk request
            TIMEOUT: 15000,
            // Retry attempts
            MAX_RETRIES: 3
        };

        // Test connection to Google Sheets
        async function testGoogleSheetsConnection() {
            try {
                console.log('üîÑ Testing connection to Google Sheets...');
                
                // Create timeout promise
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Connection timeout after 15 seconds')), GOOGLE_SHEETS_CONFIG.TIMEOUT);
                });

                // Create fetch promise
                const fetchPromise = fetch(GOOGLE_SHEETS_CONFIG.WEB_APP_URL + '?test=true', {
                    method: 'GET',
                    mode: 'no-cors', // Changed to no-cors to avoid CORS issues
                    headers: {
                        'Accept': 'application/json',
                    }
                });

                // Race between fetch and timeout
                const response = await Promise.race([fetchPromise, timeoutPromise]);
                
                console.log('‚úÖ Connection test completed - assuming success due to no-cors mode');
                return { 
                    success: true, 
                    data: { 
                        status: 'Connected',
                        message: 'Google Apps Script accessible',
                        timestamp: new Date().toISOString(),
                        availableClasses: ['1A', '1B', '1C', '2A', '2B', '3A', '3B', '4A', '4B', '5A', '5B', '6A', '6B']
                    } 
                };
            } catch (error) {
                console.error('‚ùå Connection test failed:', error);
                return { success: false, error: error.message };
            }
        }

        // Send data to Google Sheets with retry mechanism
        async function sendToGoogleSheets(attendanceRecords, retryCount = 0) {
            try {
                console.log(`üì§ Sending data to Google Sheets (attempt ${retryCount + 1})...`, {
                    url: GOOGLE_SHEETS_CONFIG.WEB_APP_URL,
                    recordCount: attendanceRecords.length
                });

                // Prepare data in the format expected by Google Apps Script
                const payload = {
                    action: 'addAttendance',
                    data: attendanceRecords.map(record => ({
                        id: record.id,
                        nama: record.nama,
                        kelas: record.kelas,
                        status: record.status,
                        tanggal: record.tanggal,
                        waktu: record.waktu,
                        keterangan: record.keterangan || '',
                        timestamp: record.timestamp,
                        school: 'SDIT NURUL HIKMAH'
                    })),
                    timestamp: new Date().toISOString(),
                    source: 'Web App Absensi'
                };

                console.log('üìã Payload being sent:', payload);

                // Create timeout promise
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Request timeout after 15 seconds')), GOOGLE_SHEETS_CONFIG.TIMEOUT);
                });

                // Create fetch promise
                const fetchPromise = fetch(GOOGLE_SHEETS_CONFIG.WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Use no-cors to avoid CORS preflight issues
                    headers: {
                        'Content-Type': 'text/plain', // Changed to text/plain to avoid CORS preflight
                    },
                    body: JSON.stringify(payload)
                });

                // Race between fetch and timeout
                const response = await Promise.race([fetchPromise, timeoutPromise]);

                console.log('üì° Response received:', response.status, response.type);

                // With no-cors mode, we can't read the response, so we assume success if no error thrown
                if (response.type === 'opaque') {
                    console.log('‚úÖ Data sent successfully (opaque response - assuming success)');
                    return { 
                        success: true, 
                        message: 'Data sent to Google Sheets successfully',
                        recordCount: attendanceRecords.length,
                        timestamp: new Date().toISOString()
                    };
                }

                // If we somehow get a readable response
                if (response.ok) {
                    try {
                        const result = await response.json();
                        console.log('‚úÖ Data sent successfully:', result);
                        return result;
                    } catch (jsonError) {
                        console.log('‚úÖ Data sent successfully (JSON parse failed but request succeeded)');
                        return { 
                            success: true, 
                            message: 'Data sent successfully',
                            recordCount: attendanceRecords.length
                        };
                    }
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

            } catch (error) {
                console.error(`‚ùå Error sending to Google Sheets (attempt ${retryCount + 1}):`, error);
                
                // Retry logic
                if (retryCount < GOOGLE_SHEETS_CONFIG.MAX_RETRIES - 1) {
                    console.log(`üîÑ Retrying in 2 seconds... (${retryCount + 2}/${GOOGLE_SHEETS_CONFIG.MAX_RETRIES})`);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    return sendToGoogleSheets(attendanceRecords, retryCount + 1);
                }
                
                throw error;
            }
        }

        // Save all attendance (for bulk operations)
        async function saveAllAttendance() {
            if (!currentClass) {
                alert('Pilih kelas terlebih dahulu!');
                return;
            }
            
            const selectedDate = document.getElementById('attendanceDate').value || new Date().toISOString().split('T')[0];
            const selectedAttendance = attendanceData.filter(item => 
                item.tanggal === selectedDate && item.kelas === currentClass
            );
            
            if (selectedAttendance.length === 0) {
                alert('Belum ada data absensi yang diisi untuk tanggal yang dipilih!');
                return;
            }

            // Show loading state
            const saveBtn = event.target;
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '‚è≥ Menyimpan ke Google Sheets...';
            saveBtn.disabled = true;

            try {
                // Send to Google Sheets
                const result = await sendToGoogleSheets(selectedAttendance);
                
                if (result.success) {
                    const dateStr = new Date(selectedDate).toLocaleDateString('id-ID');
                    document.getElementById('successMessage').textContent = 
                        `‚úÖ Berhasil menyimpan ${selectedAttendance.length} data absensi untuk kelas ${currentClass} tanggal ${dateStr} ke Google Sheets!`;
                    document.getElementById('successModal').classList.remove('hidden');
                    
                    // Update displays
                    updateTodayStats();
                    updateRecentAttendance();
                    updateOverallStats();
                    loadReportData();
                    generateMonthlyReport();
                } else {
                    throw new Error(result.message || 'Gagal menyimpan ke Google Sheets');
                }
            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
                alert(`‚ùå Error menyimpan ke Google Sheets: ${error.message}\n\nData tetap tersimpan secara lokal.`);
                
                // Still show success for local save
                const dateStr = new Date(selectedDate).toLocaleDateString('id-ID');
                document.getElementById('successMessage').textContent = 
                    `‚ö†Ô∏è Data tersimpan lokal (${selectedAttendance.length} record) tapi gagal sync ke Google Sheets`;
                document.getElementById('successModal').classList.remove('hidden');
            } finally {
                // Restore button state
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }
        
        // Finish attendance - mark remaining students as Alpha and save
        function finishAttendance() {
            if (!currentClass || !currentStudents.length) {
                alert('Pilih kelas terlebih dahulu!');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            const currentTime = new Date().toLocaleTimeString('id-ID');
            const currentTimestamp = new Date().toISOString();
            
            // Get students who haven't been marked today
            const markedStudents = attendanceData
                .filter(item => item.tanggal === today && item.kelas === currentClass)
                .map(item => item.nama);
            
            const unmarkedStudents = currentStudents.filter(student => 
                !markedStudents.includes(student.name)
            );
            
            if (unmarkedStudents.length === 0) {
                // All students already marked, just save
                const todayAttendance = attendanceData.filter(item => 
                    item.tanggal === today && item.kelas === currentClass
                );
                
                document.getElementById('successMessage').textContent = 
                    `Absensi kelas ${currentClass} telah selesai! Total: ${todayAttendance.length} siswa`;
                document.getElementById('successModal').classList.remove('hidden');
                return;
            }
            
            // Confirm marking unmarked students as Alpha
            if (confirm(`${unmarkedStudents.length} siswa belum diabsen. Tandai sebagai Alpha dan selesaikan absensi?`)) {
                // Mark unmarked students as Alpha
                unmarkedStudents.forEach(student => {
                    const formData = {
                        id: Date.now() + student.id,
                        nama: student.name,
                        kelas: currentClass,
                        status: 'Alpha',
                        keterangan: 'Otomatis - tidak hadir',
                        tanggal: today,
                        waktu: currentTime,
                        timestamp: currentTimestamp
                    };
                    attendanceData.push(formData);
                });
                
                localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                
                // Update displays
                generateStudentList();
                updateTodayStats();
                updateRecentAttendance();
                updateOverallStats();
                loadReportData();
                generateMonthlyReport(); // Auto-update monthly report
                
                // Show completion message
                const totalStudents = currentStudents.length;
                const hadirCount = attendanceData.filter(item => 
                    item.tanggal === today && item.kelas === currentClass && item.status === 'Hadir'
                ).length;
                
                document.getElementById('successMessage').textContent = 
                    `Absensi kelas ${currentClass} selesai! ${hadirCount}/${totalStudents} siswa hadir. ${unmarkedStudents.length} siswa ditandai Alpha.`;
                document.getElementById('successModal').classList.remove('hidden');
            }
        }
        
        // Update date and time
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('id-ID', options);
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('id-ID');
        }
        
        // Tab navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Reset all tab buttons to inactive state
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.add('text-white/70');
                btn.classList.remove('text-white');
                btn.style.transform = 'scale(1)';
                btn.style.boxShadow = btn.style.boxShadow.replace('0 8px 25px', '0 4px 15px');
            });
            
            // Show selected tab
            document.getElementById('content-' + tabName).classList.remove('hidden');
            document.getElementById('content-' + tabName).classList.add('fade-in');
            
            // Activate selected tab button
            const activeBtn = document.getElementById('tab-' + tabName);
            activeBtn.classList.remove('text-white/70');
            activeBtn.classList.add('text-white');
            activeBtn.style.transform = 'scale(1.05)';
            
            // Update box shadow for active state
            if (tabName === 'absensi') {
                activeBtn.style.boxShadow = '0 8px 25px rgba(102, 126, 234, 0.4)';
            } else if (tabName === 'laporan') {
                activeBtn.style.boxShadow = '0 8px 25px rgba(240, 147, 251, 0.4)';
            } else if (tabName === 'rekap') {
                activeBtn.style.boxShadow = '0 8px 25px rgba(79, 172, 254, 0.4)';
            } else if (tabName === 'grafik') {
                activeBtn.style.boxShadow = '0 8px 25px rgba(67, 233, 123, 0.4)';
            } else if (tabName === 'admin') {
                activeBtn.style.boxShadow = '0 8px 25px rgba(250, 112, 154, 0.4)';
            }
        }
        

        
        // Update today's statistics
        function updateTodayStats() {
            const today = new Date().toISOString().split('T')[0];
            let todayData = attendanceData.filter(item => item.tanggal === today);
            
            // Filter by class if user is a teacher
            if (currentUser.role === 'teacher') {
                todayData = todayData.filter(item => item.kelas === currentUser.allowedClass);
            }
            
            const stats = {
                hadir: todayData.filter(item => item.status === 'Hadir').length,
                sakit: todayData.filter(item => item.status === 'Sakit').length,
                izin: todayData.filter(item => item.status === 'Izin').length,
                alpha: todayData.filter(item => item.status === 'Alpha').length
            };
            
            document.getElementById('hadirCount').textContent = stats.hadir;
            document.getElementById('sakitCount').textContent = stats.sakit;
            document.getElementById('izinCount').textContent = stats.izin;
            document.getElementById('alphaCount').textContent = stats.alpha;
        }
        
        // Update recent attendance
        function updateRecentAttendance() {
            const today = new Date().toISOString().split('T')[0];
            let todayData = attendanceData.filter(item => item.tanggal === today);
            
            // Filter by class if user is a teacher
            if (currentUser.role === 'teacher') {
                todayData = todayData.filter(item => item.kelas === currentUser.allowedClass);
            }
            
            todayData = todayData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5);
            
            const container = document.getElementById('recentAttendance');
            
            if (todayData.length === 0) {
                const className = currentUser.role === 'teacher' ? ` kelas ${currentUser.allowedClass}` : '';
                container.innerHTML = `<p class="text-white/60 text-center py-4">Belum ada data absensi${className} hari ini</p>`;
                return;
            }
            
            container.innerHTML = todayData.map(item => {
                const statusColor = {
                    'Hadir': 'text-green-300',
                    'Sakit': 'text-yellow-300',
                    'Izin': 'text-blue-300',
                    'Alpha': 'text-red-300'
                };
                
                const statusIcon = {
                    'Hadir': '‚úÖ',
                    'Sakit': 'ü§í',
                    'Izin': 'üìù',
                    'Alpha': '‚ùå'
                };
                
                return `
                    <div class="flex justify-between items-center p-3 bg-white/5 rounded-lg">
                        <div>
                            <div class="text-white font-medium">${item.nama}</div>
                            <div class="text-white/60 text-sm">${item.kelas} ‚Ä¢ ${item.waktu}</div>
                        </div>
                        <div class="text-right">
                            <div class="${statusColor[item.status]} font-semibold">
                                ${statusIcon[item.status]} ${item.status}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update overall statistics
        function updateOverallStats() {
            const stats = {
                total: attendanceData.length,
                hadir: attendanceData.filter(item => item.status === 'Hadir').length,
                sakit: attendanceData.filter(item => item.status === 'Sakit').length,
                izin: attendanceData.filter(item => item.status === 'Izin').length,
                alpha: attendanceData.filter(item => item.status === 'Alpha').length
            };
            
            document.getElementById('totalAbsensi').textContent = stats.total;
            document.getElementById('totalHadir').textContent = stats.hadir;
            document.getElementById('totalSakit').textContent = stats.sakit;
            document.getElementById('totalIzin').textContent = stats.izin;
            document.getElementById('totalAlpha').textContent = stats.alpha;
            
            // Update last update time
            if (attendanceData.length > 0) {
                const lastEntry = attendanceData[attendanceData.length - 1];
                document.getElementById('lastUpdate').textContent = new Date(lastEntry.timestamp).toLocaleString('id-ID');
            }
        }
        
        // Load report data
        function loadReportData() {
            filterReport();
        }
        
        // Filter report
        function filterReport() {
            const filterKelas = document.getElementById('filterKelas').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            let filteredData = attendanceData;
            
            // If user is a teacher, only show their class data
            if (currentUser.role === 'teacher') {
                filteredData = filteredData.filter(item => item.kelas === currentUser.allowedClass);
            } else if (filterKelas) {
                filteredData = filteredData.filter(item => item.kelas === filterKelas);
            }
            
            if (startDate) {
                filteredData = filteredData.filter(item => item.tanggal >= startDate);
            }
            
            if (endDate) {
                filteredData = filteredData.filter(item => item.tanggal <= endDate);
            }
            
            // Sort by date (newest first), then by name alphabetically
            filteredData.sort((a, b) => {
                const dateCompare = new Date(b.timestamp) - new Date(a.timestamp);
                if (dateCompare !== 0) return dateCompare;
                return a.nama.localeCompare(b.nama);
            });
            
            const tbody = document.getElementById('reportTable');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-white/60">Tidak ada data yang sesuai filter</td></tr>';
                return;
            }
            
            tbody.innerHTML = filteredData.map((item, index) => {
                const statusColor = {
                    'Hadir': 'text-green-300',
                    'Sakit': 'text-yellow-300',
                    'Izin': 'text-blue-300',
                    'Alpha': 'text-red-300'
                };
                
                const statusIcon = {
                    'Hadir': '‚úÖ',
                    'Sakit': 'ü§í',
                    'Izin': 'üìù',
                    'Alpha': '‚ùå'
                };
                
                return `
                    <tr class="border-b border-white/10">
                        <td class="py-3 px-4">${index + 1}</td>
                        <td class="py-3 px-4">${new Date(item.tanggal).toLocaleDateString('id-ID')}</td>
                        <td class="py-3 px-4 font-medium">${item.nama}</td>
                        <td class="py-3 px-4">${item.kelas}</td>
                        <td class="py-3 px-4 ${statusColor[item.status]}">
                            ${statusIcon[item.status]} ${item.status}
                        </td>
                        <td class="py-3 px-4">${item.waktu}</td>
                        <td class="py-3 px-4">${item.keterangan || '-'}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Export report to PDF
        function exportReportToPDF() {
            // Check if there's data to export
            const reportTable = document.getElementById('reportTable');
            if (reportTable.innerHTML.includes('Tidak ada data yang sesuai filter') || reportTable.innerHTML.includes('Belum ada data absensi')) {
                alert('Tidak ada data untuk diexport. Silakan pilih filter yang sesuai atau tambahkan data absensi terlebih dahulu.');
                return;
            }
            
            // Show loading state
            const exportBtn = event.target;
            const originalText = exportBtn.innerHTML;
            exportBtn.innerHTML = '‚è≥ Membuat PDF...';
            exportBtn.disabled = true;
            
            try {
                // Wait for jsPDF to be ready
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('jsPDF library not loaded');
                }
                
                // Get filter info
                const filterKelas = document.getElementById('filterKelas').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                let dateRange = '';
                if (startDate && endDate) {
                    if (startDate === endDate) {
                        dateRange = `Tanggal: ${new Date(startDate).toLocaleDateString('id-ID')}`;
                    } else {
                        dateRange = `Periode: ${new Date(startDate).toLocaleDateString('id-ID')} - ${new Date(endDate).toLocaleDateString('id-ID')}`;
                    }
                } else {
                    dateRange = `Tanggal: ${new Date().toLocaleDateString('id-ID')}`;
                }
                
                if (filterKelas) {
                    dateRange += ` | Kelas: ${filterKelas}`;
                }
                
                // Create PDF using jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Add header
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.text('LAPORAN ABSENSI SISWA', 105, 20, { align: 'center' });
                pdf.text('SDIT NURUL HIKMAH', 105, 30, { align: 'center' });
                
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'normal');
                pdf.text(dateRange, 105, 40, { align: 'center' });
                
                // Get filtered data directly from attendanceData
                const filterKelasValue = document.getElementById('filterKelas').value;
                const startDateValue = document.getElementById('startDate').value;
                const endDateValue = document.getElementById('endDate').value;
                
                let filteredData = [...attendanceData]; // Create copy
                
                // Apply filters
                if (currentUser.role === 'teacher') {
                    filteredData = filteredData.filter(item => item.kelas === currentUser.allowedClass);
                } else if (filterKelasValue) {
                    filteredData = filteredData.filter(item => item.kelas === filterKelasValue);
                }
                
                if (startDateValue) {
                    filteredData = filteredData.filter(item => item.tanggal >= startDateValue);
                }
                
                if (endDateValue) {
                    filteredData = filteredData.filter(item => item.tanggal <= endDateValue);
                }
                
                // Sort by date (newest first), then by name
                filteredData.sort((a, b) => {
                    const dateCompare = new Date(b.timestamp) - new Date(a.timestamp);
                    if (dateCompare !== 0) return dateCompare;
                    return a.nama.localeCompare(b.nama);
                });
                
                if (filteredData.length === 0) {
                    pdf.setFontSize(14);
                    pdf.text('Tidak ada data untuk ditampilkan', 105, 80, { align: 'center' });
                } else {
                    // Table headers
                    const headers = ['No', 'Tanggal', 'Nama Siswa', 'Kelas', 'Status', 'Waktu', 'Keterangan'];
                    
                    // Add table
                    let yPos = 55;
                    const rowHeight = 8;
                    const colWidths = [15, 25, 50, 20, 25, 20, 35];
                    let xPos = 10;
                    
                    // Draw headers
                    pdf.setFontSize(10);
                    pdf.setFont(undefined, 'bold');
                    headers.forEach((header, index) => {
                        pdf.rect(xPos, yPos, colWidths[index], rowHeight);
                        pdf.text(header, xPos + colWidths[index]/2, yPos + 5, { align: 'center' });
                        xPos += colWidths[index];
                    });
                    
                    yPos += rowHeight;
                    pdf.setFont(undefined, 'normal');
                    
                    // Draw data rows
                    filteredData.forEach((item, index) => {
                        if (yPos > 270) { // New page if needed
                            pdf.addPage();
                            yPos = 20;
                        }
                        
                        xPos = 10;
                        const rowData = [
                            (index + 1).toString(),
                            new Date(item.tanggal).toLocaleDateString('id-ID'),
                            item.nama.length > 20 ? item.nama.substring(0, 17) + '...' : item.nama,
                            item.kelas,
                            item.status,
                            item.waktu,
                            item.keterangan || '-'
                        ];
                        
                        rowData.forEach((cell, cellIndex) => {
                            pdf.rect(xPos, yPos, colWidths[cellIndex], rowHeight);
                            pdf.text(cell, xPos + colWidths[cellIndex]/2, yPos + 5, { align: 'center' });
                            xPos += colWidths[cellIndex];
                        });
                        yPos += rowHeight;
                    });
                }
                
                // Add signature section
                yPos += 20;
                if (yPos > 250) {
                    pdf.addPage();
                    yPos = 30;
                }
                
                pdf.setFontSize(10);
                pdf.text('Mengetahui,', 50, yPos);
                pdf.text('Jakarta, ' + new Date().toLocaleDateString('id-ID'), 150, yPos);
                
                yPos += 10;
                pdf.setFont(undefined, 'bold');
                pdf.text('Kepala SDIT Nurul Hikmah', 50, yPos);
                pdf.text('Guru Kelas', 150, yPos);
                
                yPos += 30;
                pdf.text('(...........................)', 50, yPos);
                pdf.text('(...........................)', 150, yPos);
                
                // Add footer
                const pageCount = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(8);
                    pdf.setFont(undefined, 'normal');
                    pdf.text(`Halaman ${i} dari ${pageCount}`, 105, 290, { align: 'center' });
                    pdf.text('‚ú® @2025_Umam Project ‚ú®', 105, 295, { align: 'center' });
                }
                
                // Generate filename
                const today = new Date().toISOString().split('T')[0];
                const kelasInfo = filterKelasValue ? `_${filterKelasValue}` : '';
                const filename = `Laporan_Absensi${kelasInfo}_${today}.pdf`;
                
                // Force download using blob
                const pdfBlob = pdf.output('blob');
                const url = URL.createObjectURL(pdfBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                // Show success message
                setTimeout(() => {
                    alert(`‚úÖ PDF berhasil didownload! File: ${filename}`);
                }, 300);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('‚ùå Terjadi kesalahan saat membuat PDF: ' + error.message);
            } finally {
                // Restore button state
                setTimeout(() => {
                    exportBtn.innerHTML = originalText;
                    exportBtn.disabled = false;
                }, 1000);
            }
        }
        
        // Export data
        function exportData() {
            const dataStr = JSON.stringify(attendanceData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `absensi_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        // Clear today's data
        function clearTodayData() {
            if (confirm('Apakah Anda yakin ingin menghapus semua data absensi hari ini?')) {
                const today = new Date().toISOString().split('T')[0];
                attendanceData = attendanceData.filter(item => item.tanggal !== today);
                localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                
                updateTodayStats();
                updateRecentAttendance();
                updateOverallStats();
                loadReportData();
                
                alert('Data absensi hari ini berhasil dihapus!');
            }
        }
        
        // Clear all data
        function clearAllData() {
            if (confirm('PERINGATAN: Apakah Anda yakin ingin menghapus SEMUA data absensi? Tindakan ini tidak dapat dibatalkan!')) {
                if (confirm('Konfirmasi sekali lagi: Hapus SEMUA data absensi?')) {
                    attendanceData = [];
                    localStorage.removeItem('attendanceData');
                    
                    updateTodayStats();
                    updateRecentAttendance();
                    updateOverallStats();
                    loadReportData();
                    
                    alert('Semua data absensi berhasil dihapus!');
                }
            }
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('successModal').classList.add('hidden');
        }
        
        // Close modal when clicking outside
        document.getElementById('successModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        // Calculate working days in a month (Monday to Friday)
        function getWorkingDaysInMonth(year, month) {
            const daysInMonth = new Date(year, month, 0).getDate();
            let workingDays = 0;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const dayOfWeek = date.getDay();
                // Monday = 1, Tuesday = 2, ..., Friday = 5
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    workingDays++;
                }
            }
            
            return workingDays;
        }
        
        // Generate monthly report
        function generateMonthlyReport() {
            const filterKelas = document.getElementById('monthlyFilterKelas').value;
            const monthlyPeriod = document.getElementById('monthlyPeriod').value;
            
            if (!monthlyPeriod) {
                document.getElementById('monthlyReportTable').innerHTML = 
                    '<tr><td colspan="8" class="text-center py-8 text-white/60">Pilih periode untuk menampilkan rekap bulanan</td></tr>';
                return;
            }
            
            const [year, month] = monthlyPeriod.split('-').map(Number);
            const workingDays = getWorkingDaysInMonth(year, month);
            
            // Filter data by month and class
            let monthlyData = attendanceData.filter(item => {
                const itemDate = new Date(item.tanggal);
                return itemDate.getFullYear() === year && itemDate.getMonth() === month - 1;
            });
            
            // If user is a teacher, only show their class data
            if (currentUser.role === 'teacher') {
                monthlyData = monthlyData.filter(item => item.kelas === currentUser.allowedClass);
            } else if (filterKelas) {
                monthlyData = monthlyData.filter(item => item.kelas === filterKelas);
            }
            
            // Group by student
            const studentStats = {};
            monthlyData.forEach(item => {
                if (!studentStats[item.nama]) {
                    studentStats[item.nama] = {
                        nama: item.nama,
                        kelas: item.kelas,
                        hadir: 0,
                        sakit: 0,
                        izin: 0,
                        alpha: 0
                    };
                }
                studentStats[item.nama][item.status.toLowerCase()]++;
            });
            
            // Convert to array and calculate percentages
            const studentsArray = Object.values(studentStats);
            studentsArray.forEach(student => {
                const totalDays = student.hadir + student.sakit + student.izin + student.alpha;
                student.percentage = totalDays > 0 ? Math.round((student.hadir / workingDays) * 100) : 0;
            });
            
            // Sort by name
            studentsArray.sort((a, b) => a.nama.localeCompare(b.nama));
            
            // Update summary cards
            const totalStudents = studentsArray.length;
            const totalRecords = monthlyData.length;
            const avgAttendance = studentsArray.length > 0 
                ? Math.round(studentsArray.reduce((sum, s) => sum + s.percentage, 0) / studentsArray.length)
                : 0;
            
            document.getElementById('monthlyWorkDays').textContent = workingDays;
            document.getElementById('monthlyAvgAttendance').textContent = avgAttendance + '%';
            document.getElementById('monthlyTotalStudents').textContent = totalStudents;
            document.getElementById('monthlyTotalRecords').textContent = totalRecords;
            
            // Update table
            const tbody = document.getElementById('monthlyReportTable');
            const tfoot = document.getElementById('monthlyReportTotal');
            
            if (studentsArray.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">Tidak ada data untuk periode yang dipilih</td></tr>';
                tfoot.style.display = 'none';
                return;
            }
            
            tbody.innerHTML = studentsArray.map((student, index) => {
                const percentageColor = student.percentage >= 80 ? 'text-green-700' : 
                                      student.percentage >= 60 ? 'text-yellow-700' : 'text-red-700';
                
                return `
                    <tr class="border-b border-gray-200">
                        <td class="py-3 px-4">${index + 1}</td>
                        <td class="py-3 px-4 font-medium">${student.nama}</td>
                        <td class="py-3 px-4">${student.kelas}</td>
                        <td class="py-3 px-4 text-green-700">${student.hadir}</td>
                        <td class="py-3 px-4 text-yellow-700">${student.sakit}</td>
                        <td class="py-3 px-4 text-blue-700">${student.izin}</td>
                        <td class="py-3 px-4 text-red-700">${student.alpha}</td>
                        <td class="py-3 px-4 font-semibold ${percentageColor}">${student.percentage}%</td>
                    </tr>
                `;
            }).join('');
            
            // Calculate totals
            const totals = studentsArray.reduce((acc, student) => {
                acc.hadir += student.hadir;
                acc.sakit += student.sakit;
                acc.izin += student.izin;
                acc.alpha += student.alpha;
                return acc;
            }, { hadir: 0, sakit: 0, izin: 0, alpha: 0 });
            
            const totalPercentage = studentsArray.length > 0 
                ? Math.round((totals.hadir / (studentsArray.length * workingDays)) * 100)
                : 0;
            
            document.getElementById('totalHadirBulanan').textContent = totals.hadir;
            document.getElementById('totalSakitBulanan').textContent = totals.sakit;
            document.getElementById('totalIzinBulanan').textContent = totals.izin;
            document.getElementById('totalAlphaBulanan').textContent = totals.alpha;
            document.getElementById('totalPersentaseBulanan').textContent = totalPercentage + '%';
            
            tfoot.style.display = 'table-footer-group';
            
            // Update print date
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            const printDate = `${monthNames[month - 1]} ${year}`;
            document.getElementById('printMonthlyDate').textContent = printDate;
            document.getElementById('monthlyReportSignatureDate').textContent = 
                `Jakarta, ${new Date().toLocaleDateString('id-ID')}`;
        }
        
        // Refresh monthly period to current month
        function refreshMonthlyPeriod() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            document.getElementById('monthlyPeriod').value = currentMonth;
            generateMonthlyReport();
        }
        
        // Export monthly report to PDF
        function exportMonthlyReportToPDF() {
            // Check if there's data to export
            const reportTable = document.getElementById('monthlyReportTable');
            if (reportTable.innerHTML.includes('Tidak ada data untuk periode yang dipilih')) {
                alert('Tidak ada data untuk diexport. Silakan pilih periode yang sesuai atau tambahkan data absensi terlebih dahulu.');
                return;
            }
            
            // Show loading state
            const exportBtn = event.target;
            const originalText = exportBtn.innerHTML;
            exportBtn.innerHTML = '‚è≥ Membuat PDF...';
            exportBtn.disabled = true;
            
            try {
                // Wait for jsPDF to be ready
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('jsPDF library not loaded');
                }
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Get filter info
                const filterKelas = document.getElementById('monthlyFilterKelas').value;
                const monthlyPeriod = document.getElementById('monthlyPeriod').value;
                const [year, month] = monthlyPeriod.split('-').map(Number);
                
                const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                                  'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                const periodText = `${monthNames[month - 1]} ${year}`;
                
                // Add header
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.text('REKAP ABSENSI BULANAN', 105, 20, { align: 'center' });
                pdf.text('SDIT NURUL HIKMAH', 105, 30, { align: 'center' });
                
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'normal');
                let headerText = `Periode: ${periodText}`;
                if (filterKelas) {
                    headerText += ` | Kelas: ${filterKelas}`;
                }
                pdf.text(headerText, 105, 40, { align: 'center' });
                
                // Get data from the current monthly report
                const tbody = document.getElementById('monthlyReportTable');
                const rows = tbody.querySelectorAll('tr');
                
                if (rows.length === 0 || rows[0].textContent.includes('Tidak ada data')) {
                    pdf.setFontSize(14);
                    pdf.text('Tidak ada data untuk ditampilkan', 105, 80, { align: 'center' });
                } else {
                    // Table headers
                    const headers = ['No', 'Nama Siswa', 'Kelas', 'Hadir', 'Sakit', 'Izin', 'Alpha', '% Kehadiran'];
                    
                    // Add table
                    let yPos = 55;
                    const rowHeight = 8;
                    const colWidths = [15, 60, 20, 20, 20, 20, 20, 25];
                    let xPos = 10;
                    
                    // Draw headers
                    pdf.setFontSize(10);
                    pdf.setFont(undefined, 'bold');
                    headers.forEach((header, index) => {
                        pdf.rect(xPos, yPos, colWidths[index], rowHeight);
                        pdf.text(header, xPos + colWidths[index]/2, yPos + 5, { align: 'center' });
                        xPos += colWidths[index];
                    });
                    
                    yPos += rowHeight;
                    pdf.setFont(undefined, 'normal');
                    
                    // Draw data rows
                    rows.forEach((row, index) => {
                        if (yPos > 270) { // New page if needed
                            pdf.addPage();
                            yPos = 20;
                        }
                        
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 8) {
                            xPos = 10;
                            cells.forEach((cell, cellIndex) => {
                                if (cellIndex < 8) {
                                    pdf.rect(xPos, yPos, colWidths[cellIndex], rowHeight);
                                    let cellText = cell.textContent.trim();
                                    if (cellIndex === 1 && cellText.length > 25) { // Name column
                                        cellText = cellText.substring(0, 22) + '...';
                                    }
                                    pdf.text(cellText, xPos + colWidths[cellIndex]/2, yPos + 5, { align: 'center' });
                                    xPos += colWidths[cellIndex];
                                }
                            });
                            yPos += rowHeight;
                        }
                    });
                    
                    // Add totals row
                    const totalRow = document.getElementById('monthlyReportTotal').querySelector('tr');
                    if (totalRow && yPos <= 270) {
                        yPos += 2; // Small gap
                        const totalCells = totalRow.querySelectorAll('td');
                        if (totalCells.length >= 8) {
                            xPos = 10;
                            pdf.setFont(undefined, 'bold');
                            totalCells.forEach((cell, cellIndex) => {
                                if (cellIndex < 8) {
                                    pdf.rect(xPos, yPos, colWidths[cellIndex], rowHeight);
                                    pdf.text(cell.textContent.trim(), xPos + colWidths[cellIndex]/2, yPos + 5, { align: 'center' });
                                    xPos += colWidths[cellIndex];
                                }
                            });
                        }
                    }
                }
                
                // Add signature section
                yPos += 30;
                if (yPos > 250) {
                    pdf.addPage();
                    yPos = 30;
                }
                
                pdf.setFontSize(10);
                pdf.setFont(undefined, 'normal');
                pdf.text('Mengetahui,', 50, yPos);
                pdf.text('Jakarta, ' + new Date().toLocaleDateString('id-ID'), 150, yPos);
                
                yPos += 10;
                pdf.setFont(undefined, 'bold');
                pdf.text('Kepala SDIT Nurul Hikmah', 50, yPos);
                pdf.text('Guru Kelas', 150, yPos);
                
                yPos += 30;
                pdf.text('(...........................)', 50, yPos);
                pdf.text('(...........................)', 150, yPos);
                
                // Add footer
                const pageCount = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(8);
                    pdf.setFont(undefined, 'normal');
                    pdf.text(`Halaman ${i} dari ${pageCount}`, 105, 290, { align: 'center' });
                    pdf.text('‚ú® @2025_Umam Project ‚ú®', 105, 295, { align: 'center' });
                }
                
                // Generate filename
                const kelasInfo = filterKelas ? `_${filterKelas}` : '';
                const filename = `Rekap_Bulanan${kelasInfo}_${monthNames[month-1]}_${year}.pdf`;
                
                // Force download
                const pdfBlob = pdf.output('blob');
                const url = URL.createObjectURL(pdfBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                setTimeout(() => {
                    alert(`‚úÖ PDF berhasil didownload! File: ${filename}`);
                }, 300);
                
            } catch (error) {
                console.error('Error generating monthly PDF:', error);
                alert('‚ùå Terjadi kesalahan saat membuat PDF: ' + error.message);
            } finally {
                setTimeout(() => {
                    exportBtn.innerHTML = originalText;
                    exportBtn.disabled = false;
                }, 1000);
            }
        }
        
        // Chart functions
        function updateCharts() {
            drawStatusChart();
            drawTrendChart();
            if (currentUser.role === 'admin') {
                drawClassComparisonChart();
            }
        }
        
        function refreshCharts() {
            updateCharts();
            alert('üìä Grafik berhasil diperbarui!');
        }
        
        function drawStatusChart() {
            const canvas = document.getElementById('statusChart');
            const ctx = canvas.getContext('2d');
            const filterKelas = document.getElementById('chartFilterKelas').value;
            const period = parseInt(document.getElementById('chartPeriod').value);
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Get data for the period
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - period);
            
            let chartData = attendanceData.filter(item => {
                const itemDate = new Date(item.tanggal);
                return itemDate >= startDate && itemDate <= endDate;
            });
            
            // Filter by class if specified
            if (currentUser.role === 'teacher') {
                chartData = chartData.filter(item => item.kelas === currentUser.allowedClass);
            } else if (filterKelas) {
                chartData = chartData.filter(item => item.kelas === filterKelas);
            }
            
            // Count status
            const statusCounts = {
                'Hadir': chartData.filter(item => item.status === 'Hadir').length,
                'Sakit': chartData.filter(item => item.status === 'Sakit').length,
                'Izin': chartData.filter(item => item.status === 'Izin').length,
                'Alpha': chartData.filter(item => item.status === 'Alpha').length
            };
            
            const total = Object.values(statusCounts).reduce((a, b) => a + b, 0);
            
            if (total === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Tidak ada data', canvas.width/2, canvas.height/2);
                return;
            }
            
            // Draw pie chart
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 20;
            
            const colors = {
                'Hadir': '#10b981',
                'Sakit': '#f59e0b',
                'Izin': '#3b82f6',
                'Alpha': '#ef4444'
            };
            
            let currentAngle = -Math.PI / 2;
            
            Object.entries(statusCounts).forEach(([status, count]) => {
                if (count > 0) {
                    const sliceAngle = (count / total) * 2 * Math.PI;
                    
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                    ctx.closePath();
                    ctx.fillStyle = colors[status];
                    ctx.fill();
                    
                    currentAngle += sliceAngle;
                }
            });
            
            // Update legend
            const legend = document.getElementById('statusLegend');
            legend.innerHTML = Object.entries(statusCounts).map(([status, count]) => {
                const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
                return `
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded mr-2" style="background-color: ${colors[status]}"></div>
                        <span>${status}: ${count} (${percentage}%)</span>
                    </div>
                `;
            }).join('');
        }
        
        function drawTrendChart() {
            const canvas = document.getElementById('trendChart');
            const ctx = canvas.getContext('2d');
            const filterKelas = document.getElementById('chartFilterKelas').value;
            const period = parseInt(document.getElementById('chartPeriod').value);
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Get data for the period
            const endDate = new Date();
            const dates = [];
            for (let i = period - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(endDate.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);
            }
            
            // Calculate attendance rate for each date
            const attendanceRates = dates.map(date => {
                let dayData = attendanceData.filter(item => item.tanggal === date);
                
                if (currentUser.role === 'teacher') {
                    dayData = dayData.filter(item => item.kelas === currentUser.allowedClass);
                } else if (filterKelas) {
                    dayData = dayData.filter(item => item.kelas === filterKelas);
                }
                
                const total = dayData.length;
                const present = dayData.filter(item => item.status === 'Hadir').length;
                return total > 0 ? (present / total) * 100 : 0;
            });
            
            if (attendanceRates.every(rate => rate === 0)) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Tidak ada data', canvas.width/2, canvas.height/2);
                return;
            }
            
            // Draw line chart
            const padding = 40;
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;
            
            // Draw axes
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, padding + chartHeight);
            ctx.lineTo(padding + chartWidth, padding + chartHeight);
            ctx.stroke();
            
            // Draw line
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            attendanceRates.forEach((rate, index) => {
                const x = padding + (index / (dates.length - 1)) * chartWidth;
                const y = padding + chartHeight - (rate / 100) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Draw points
            ctx.fillStyle = '#3b82f6';
            attendanceRates.forEach((rate, index) => {
                const x = padding + (index / (dates.length - 1)) * chartWidth;
                const y = padding + chartHeight - (rate / 100) * chartHeight;
                
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            // Update trend info
            const avgRate = attendanceRates.reduce((a, b) => a + b, 0) / attendanceRates.length;
            const trendInfo = document.getElementById('trendInfo');
            trendInfo.innerHTML = `Rata-rata kehadiran ${period} hari terakhir: ${Math.round(avgRate)}%`;
        }
        
        function drawClassComparisonChart() {
            const canvas = document.getElementById('classChart');
            const ctx = canvas.getContext('2d');
            const period = parseInt(document.getElementById('chartPeriod').value);
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Get data for all classes
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - period);
            
            const chartData = attendanceData.filter(item => {
                const itemDate = new Date(item.tanggal);
                return itemDate >= startDate && itemDate <= endDate;
            });
            
            // Group by class
            const classCounts = {};
            Object.keys(studentsByClass).forEach(kelas => {
                const classData = chartData.filter(item => item.kelas === kelas);
                const total = classData.length;
                const present = classData.filter(item => item.status === 'Hadir').length;
                classCounts[kelas] = total > 0 ? (present / total) * 100 : 0;
            });
            
            const classes = Object.keys(classCounts);
            const rates = Object.values(classCounts);
            
            if (rates.every(rate => rate === 0)) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Tidak ada data', canvas.width/2, canvas.height/2);
                return;
            }
            
            // Draw bar chart
            const padding = 60;
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;
            const barWidth = chartWidth / classes.length - 10;
            
            // Draw axes
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, padding + chartHeight);
            ctx.lineTo(padding + chartWidth, padding + chartHeight);
            ctx.stroke();
            
            // Draw bars
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
            
            classes.forEach((kelas, index) => {
                const rate = rates[index];
                const barHeight = (rate / 100) * chartHeight;
                const x = padding + index * (chartWidth / classes.length) + 5;
                const y = padding + chartHeight - barHeight;
                
                ctx.fillStyle = colors[index % colors.length];
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // Draw class label
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(kelas, x + barWidth/2, padding + chartHeight + 20);
                
                // Draw percentage
                ctx.fillText(Math.round(rate) + '%', x + barWidth/2, y - 5);
            });
        }
        
        function exportChartsToPDF() {
            alert('üìä Fitur export grafik ke PDF akan segera tersedia!');
        }
        
        // Test connection to Google Sheets
        async function testConnection() {
            const testBtn = event.target;
            const originalText = testBtn.innerHTML;
            testBtn.innerHTML = '‚è≥ Testing Connection...';
            testBtn.disabled = true;

            try {
                console.log('üß™ Manual connection test started...');
                const result = await testGoogleSheetsConnection();
                
                if (result.success) {
                    const message = `‚úÖ KONEKSI BERHASIL!

üìä Status: ${result.data.status}
üîó API: ${result.data.message}
‚è∞ Waktu: ${new Date(result.data.timestamp).toLocaleString('id-ID')}

üìö Kelas Tersedia:
${result.data.availableClasses?.join(', ') || 'Semua kelas siap'}

üéØ Google Apps Script siap menerima data absensi!

üí° Tips:
- Data akan otomatis tersync setiap kali input absensi
- Setiap kelas akan disimpan di sheet terpisah
- Backup lokal tetap berfungsi sebagai cadangan`;

                    alert(message);
                    
                    // Update connection status in header
                    const statusDiv = document.getElementById('connectionStatus');
                    statusDiv.className = 'text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-300';
                    statusDiv.textContent = '‚úÖ Connected to Sheets';
                    
                } else {
                    const troubleshootMessage = `‚ùå KONEKSI GAGAL!

üîç Error Details: ${result.error}

üõ†Ô∏è TROUBLESHOOTING STEPS:

1Ô∏è‚É£ CEK GOOGLE APPS SCRIPT:
   - Buka script.google.com
   - Pastikan project sudah di-deploy
   - Status deployment: "Active"

2Ô∏è‚É£ CEK PERMISSIONS:
   - Execute as: "Me"
   - Who has access: "Anyone"
   - Tidak perlu login Google

3Ô∏è‚É£ CEK URL WEB APP:
   - URL harus berakhiran "/exec"
   - Bukan "/dev" atau "/edit"

4Ô∏è‚É£ CEK INTERNET:
   - Pastikan koneksi internet stabil
   - Coba refresh halaman

üìû Jika masih bermasalah, cek Console (F12) untuk detail error.`;

                    alert(troubleshootMessage);
                    
                    // Update connection status in header
                    const statusDiv = document.getElementById('connectionStatus');
                    statusDiv.className = 'text-xs px-2 py-1 rounded-full bg-red-500/20 text-red-300';
                    statusDiv.textContent = '‚ùå Connection failed';
                }
            } catch (error) {
                console.error('‚ùå Test connection error:', error);
                
                const errorMessage = `‚ùå ERROR TESTING CONNECTION!

üö® Error: ${error.message}

üîß LANGKAH PERBAIKAN:

1. Cek Console Browser (tekan F12)
2. Lihat tab "Console" untuk error detail
3. Pastikan URL Google Apps Script benar
4. Coba test lagi setelah beberapa saat

üìã URL saat ini:
${GOOGLE_SHEETS_CONFIG.WEB_APP_URL}

üí° Sistem akan tetap menyimpan data secara lokal meskipun koneksi gagal.`;

                alert(errorMessage);
                
                // Update connection status in header
                const statusDiv = document.getElementById('connectionStatus');
                statusDiv.className = 'text-xs px-2 py-1 rounded-full bg-red-500/20 text-red-300';
                statusDiv.textContent = '‚ùå Connection error';
                
            } finally {
                testBtn.innerHTML = originalText;
                testBtn.disabled = false;
            }
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = today;
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            
            // Set current month for monthly report
            const currentMonth = new Date().toISOString().slice(0, 7);
            document.getElementById('monthlyPeriod').value = currentMonth;

            // Auto-test connection on load (silent)
            setTimeout(async () => {
                const statusDiv = document.getElementById('connectionStatus');
                try {
                    console.log('üîÑ Auto-testing Google Sheets connection...');
                    const result = await testGoogleSheetsConnection();
                    if (result.success) {
                        console.log('üéâ Auto-connection test successful!', result.data);
                        statusDiv.className = 'text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-300';
                        statusDiv.textContent = '‚úÖ Connected to Sheets';
                        statusDiv.title = `Connected at ${new Date(result.data.timestamp).toLocaleTimeString('id-ID')}`;
                    } else {
                        console.warn('‚ö†Ô∏è Auto-connection test failed:', result.error);
                        statusDiv.className = 'text-xs px-2 py-1 rounded-full bg-yellow-500/20 text-yellow-300';
                        statusDiv.textContent = '‚ö†Ô∏è Connection issue';
                        statusDiv.title = `Error: ${result.error}`;
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Auto-connection test error:', error.message);
                    statusDiv.className = 'text-xs px-2 py-1 rounded-full bg-yellow-500/20 text-yellow-300';
                    statusDiv.textContent = '‚ö†Ô∏è Connection issue';
                    statusDiv.title = `Error: ${error.message}`;
                }
            }, 3000);
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96f12500765f3e14',t:'MTc1NTE4MTc2OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
